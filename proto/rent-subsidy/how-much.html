<!DOCTYPE html>
<html class="no-js" lang="en" dir="ltr">
   <head>
      <meta charset="utf-8" />
      <!-- Web Experience Toolkit (WET) / Boîte à outils de l'expérience Web (BOEW) wet-boew.github.io/wet-boew/License-en.html / wet-boew.github.io/wet-boew/Licence-fr.html -->
      <title>Canada Emergency Rent Subsidy (CERS) – Canada.ca</title>
      <meta content="width=device-width,initial-scale=1" name="viewport" />
      <meta name="robots" content="noindex" />
      <!-- Meta data -->
      <!-- Load closure tloclate scripts -->
      <script type="text/javascript"
         src="https://www.canada.ca/etc/designs/canada/cdts/gcweb/v4_0_30/cdts/compiled/soyutils.js"></script>
      <script type="text/javascript"
         src="https://www.canada.ca/etc/designs/canada/cdts/gcweb/v4_0_30/cdts/compiled/wet-en.js"></script>
      <link href="https://test.canada.ca/covid-19-guidance/proto/css/alpha-beta-banner.css" rel="stylesheet" />
      <link href="../css/cews.css" rel="stylesheet" />
      <link href="../css/checkbox-radio-cers.css" rel="stylesheet" />
      <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
         integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous" />
      <!-- Write closure tloclate -->
      <script type="text/javascript">
         document.write(wet.builder.refTop({
         }));
      </script>
   </head>
   <body vocab="http://schema.org/" typeof="WebPage">
      <div id="def-top">
      </div>
      <!-- Write closure tloclate -->
      <script type="text/javascript">
         var defTop = document.getElementById("def-top");
         defTop.outerHTML = wet.builder.top({
           lngLinks: [{

             lang: "fr",
             href: "how-much-mt-fr.html",
             text: "Français"
           }],
           breadcrumbs: [{
             title: "Canada.ca",
             href: "https://www.canada.ca/en.html"
           }, {
             title: "Business and industry",
             href: "https://www.canada.ca/en/services/business.html"
           }, {
             title: "Canada Emergency Rent Subsidy (CERS)",
             href: "index.html"
           }],
           search: true,
           siteMenu: true,
           showPreContent: true
         });
      </script>
      <main property="mainContentOfPage" class="container">
         <section class="gc-nav">
            <h1 property="name" id="wb-cont-nav">Canada Emergency Rent Subsidy (CERS)</h1>
            <ul id="gc-navseq-nav" class="hidden-xs hidden-sm">
               <li> <a class="gc-navseq-nav-btn" href="#gc-navseq-header">Go to navigation menu</a> </li>
               <li> <a class="gc-navseq-nav-btn" href="#wb-cont">Skip to main content</a> </li>
            </ul>
            <nav aria-label="Section menu">
               <h2 id="gc-navseq-header" class="mrgn-tp-0 hidden-xs hidden-sm">Sections</h2>
               <ul class="gc-navseq">
                  <li><a href="who-apply.html">Who can apply</a></li>
                  <li><a href="periods.html">Periods you can apply for</a></li>
                  <li><a href="expenses-to-claim.html">Expenses you can claim</a></li>
                  <li class="active"><a aria-current="page">Calculate your subsidy amount</a></li>
                  <li><a href="how-apply.html">How to apply</a></li>
                  <li><a href="after.html">After you apply</a></li>
                  <li><a href="contact.html">Contact us about CERS</a></li>
               </ul>
               <div class="hidden-sm hidden-xs" data-ajax-replace="index.html #related-menu>"> </div>
            </nav>
         </section>
         <section class="gc-nav-section experimental">
            <h1 property="name" id="wb-cont">Calculate your subsidy amount</h1>
            <h2 class="h3 mrgn-tp-sm">On this page</h2>
            <ul>
              <li><a href="#h-1">How the subsidy is calculated</a></li>
               <li><a href="#h-2">Before you start the calculation</a></li>
               <li><a href="#h-3">Use the calculator</a></li>
            </ul>
            <section>
              <h2 id="h-1">How the subsidy is calculated</h2>
              <p>The CERS provides both a base subsidy and in some cases, a lockdown support amount.</p>
              <details>
                 <summary>How much can you claim</summary>
                 <p>The base subsidy rate applies to a maximum of $75,000 in eligible expenses per location and an overall maximum of $300,000 in expenses for your business and any affiliated entities per claim period.</p>
                 <p>If you must close or cease certain activities at one or more of your locations under a public health order for one week or longer, you may be eligible for lockdown support of up to 25% of eligible expenses per affected location.</p>
               </details>
               <details>
                <summary>Calculating your base rent subsidy rate</summary>
                <p>The amount you can claim of your expenses (your rent subsidy rate) is based on the <strong>revenue drop your business experienced</strong> between</p>
                <ul class="lst-lwr-alph">
                  <li><strong>Corresponding month of 2019 method:</strong> the month of 2019 and 2020 that mostly overlaps the claim period you're applying for</li>
                  <li><strong>Alternative method: </strong>January and February 2020 compared to the month of 2020 that mostly overlaps the claim period</li>
                </ul>
                <p>This revenue drop is then scaled to calculate your rent subsidy rate:</p>

                <table class="table table-condensed small">
                  <caption>Calculate your rent subsidy rate</caption>
                  <thead>
                     <tr>
                        <th scope="col">Your revenue drop</th>
                        <th scope="col">How to calculate your rate</th>
                     </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Revenue drop &gt; 70%</td>
                      <td>The maximum subsidy rate of 65%</td>
                    </tr>
                    <tr>
                      <td>Revenue drop of 50-70%</td>
                      <td>(Your revenue drop - 50%) x 1.25</td>
                    </tr>
                    <tr>
                      <td>Revenue drop &lt; 50%</td>
                      <td>0.8 x your revenue drop</td>
                    </tr>
                  </tbody>
                </table>
               </details>
               <details>
                <summary>Calculating your top up (lockdown support) rate</summary>
                <p>In addition to the rent subsidy rate, you can receive a lockdown support amount for certain locations affected by public health restrictions.</p>
                <p>Your CERS top-up (lockdown support) rate is 25% per day on lockdown, calculated as:</p>
                <ul class="fa-ul lst-spcd">
                  <li>25% (fixed top-up rate)</li>
                  <li class="brdr-bttm"><span class="fas fa-times fa-li"><span class="wb-inv">times</span></span> days the location was locked down due to COVID-19</li>
                  <li class="brdr-bttm"><span class="fas fa-divide fa-li"><span class="wb-inv">divided by</span></span> 28 (the days in the CERS period)</li>
                  <li><span class="fas fa-equals fa-li"><span class="wb-inv">equals</span></span> <span class="mrgn-tp-0 text-muted h5">Your top-up (lockdown support) rate</span></li>
                </ul>

                <p>If you have a 0% rent subsidy rate, you cannot claim a top up for any location.</p>


                <details>
                  <summary>Example top-up rate calculation</summary>
                  <p>For example, if one of your business locations was on lockdown for 7 days of the 28 day period, you would be eligible to receive:</p>
                  <ul>
                      <li>25% base top-up rate multiplied by</li>
                      <li>7 days out of 28</li>
                      <li>For a 6.25% top-up rate.</li>
                  </ul>
                </details>
              </details>
               <h2 id="h-2">Before you start the calculation</h2>
               <p class="lead">Check these boxes to confirm you have all the information you need before you start your calculation:</p>
               <section>
                  <ul class="checkbox-lg checkbox-zebra">
                     <li class="checkbox">
                        <input type="checkbox" id="bfore1" class="action-checkbox">
                        <label for="bfore1"><strong>You are eligible for CERS</strong></label>
                        <ul class="mrgn-lft-lg list-unstyled">
                           <li><a href="who-apply.html">Who can apply</a></li>
                        </ul>
                     </li>
                     <li class="checkbox">
                        <input type="checkbox" id="bfore2" class="action-checkbox">
                        <label for="bfore2"><strong>You have your monthly qualifying revenue amounts from 2020 and 2019</strong></label>
                        <!--
                        <label for="bfore2">You will need revenue amounts for the past few months, as well as your comparison period option.</label>
                      -->
                     </li>
                     <li class="checkbox">
                        <input type="checkbox" id="bfore3" class="action-checkbox">
                        <p>
                           <label for="bfore3"><strong>Your eligible expenses are broken down by business location:</strong></label>
                           <ul class="mrgn-lft-lg list-unstyled">
                              <li><a href="expenses-to-claim.html">Expenses you can claim</a></li>
                           </ul>
                        </p>
                     </li>
                     <li class="checkbox">
                        <input type="checkbox" id="bfore5" class="action-checkbox">
                        <label for="bfore5"><strong>You have already made your rent or other expense payments</strong></label>
                        <label for="bfore5">You cannot claim any rent, property tax or other expense amounts that you have not already paid.</label>
                     </li>
                     <li class="checkbox">
                        <input type="checkbox" id="bfore6" class="action-checkbox">
                        <label for="bfore6"><strong>If your business has affiliated businesses or entities:</strong></label>
                        <label for="bfore6">You have agreed with those affiliated entities on how you will split the rent subsidy maximum.</label>
                        <ul class="mrgn-lft-lg list-unstyled">
                          <li>
                            <details>
                            <summary>Find out if you have affiliated entities</summary>
                            <div data-ajax-replace="who-apply.html #affiliated"></div>
                         </details>
                          </li>
                       </ul>
                       <!--
                        <div class="row mrgn-tp-sm mrgn-bttm-sm">
                          <div class="col-xs-3 col-sm-2">
                            <p class="col-xs-12 pstn-tp-xs pstn-lft-xs text-center"><span class="fa-stack fa-fw text-muted text-center"> <span class="fas fa-circle fa-stack-2x"></span><span class="fa-stack-1x fa-inverse small">or</span></span></p>
                            <hr class="brdr-bttm">
                          </div>
                        </div>
                        <label for="bfore6"><strong>You have agreed on a percentage at which you will split the Rent Subsidy with affiliated entities.</strong></label>
                      -->
                     </li>
                  </ul>
                  <div class="alert alert-danger provisional" id="action-no-msg">
                     <p>You should understand the definitions and gather all the necessary information before you calculate
                        your claim.
                     </p>
                  </div>
                  <div class="alert alert-success hidden provisional" id="action-msg1">
                     <p>You can now proceed to calculate the amounts you will need for your claim. </p>
                  </div>
               </section>
            </section>
            <h2 id="h-3">Use the calculator</h2>
            <p>Use this calculator before you apply for the subsidy to calculate the amount you can apply for.</p>
            <p>After calculating your amounts, you will have to apply for the subsidy online through My Business Account or Represent a Client.</p>
            <p><strong>Print the information from the calculator</strong> in order to use it in your application.</p>
            <details>
               <summary>Privacy statement: This calculator does not collect your information</summary>
               <p>The CRA is not collecting or retaining any of the information you enter on this page. These amounts are only used to help you determine the amount of CERS you may be eligible to
                  claim. You may be required to provide a full list of your business locations and their expenses
                  for verification after you apply.
               </p>
            </details>
            <div class="alert alert-warning provisional" id="action-no-msg">
            <p><strong>Warning:</strong> This calculator does not save any data and if you leave or refresh this page you may need to enter the information again.</p>
          </div>
            <div class="wb-frmvld">
               <form method="get" class="mrgn-bttm-lg" id="cews-cal">
                  <ol class="lst-stps">
                     <li id="stp1">
                        <fieldset>
                           <legend><span class="wb-inv">Step 1: </span>Claim period</legend>
                           <div class="form-group">
                              <label for="claim-period" class="control-label required"><span class="field-name">Select the period you are claiming for</span> <strong class="required">(required)</strong></label>
                              <select required id="claim-period" class="form-control input-lg">
                                 <option value=""> Select a claim period</option>
                                 <option data-claim-period="1" value="2020-09-27--2020-10-24">Period 1: September 27, 2020, to October 24, 2020</option>
                                 <!-- <option data-claim-period="2" value="2020-10-25--2020-11-21">Period 2: October 25, 2020, to November 21, 2020</option>
                                 <option data-claim-period="3" value="2020-11-22--2020-12-19">Period 3: November 22, 2020, to December 19, 2020</option> -->
                              </select>
                           </div>
                        </fieldset>
                        <hr class="brdr-bttm">
                        <div class="well mrgn-tp-md mrgn-bttm-lg">
                           <h3 class="mrgn-tp-0">Summary of Step 1</h3>
                           <ul class="list-unstyled lst-spcd">
                              <li>Claim period is: <span class="h3 claim-period"></span></li>
                           </ul>
                        </div>
                     </li>
                     <li id="stp1">
                        <fieldset>
                           <legend><span class="wb-inv">Step 2: </span>Related businesses, charities, and non-profit organizations</legend>
                           <p>You and any related businesses, charities, and non-profit organizations (affiliated entities) are only eligible for the CERS base subsidy amount on a combined maximum of $300,000 in eligible expenses.</p>
                           <details>
                           <summary>Find out if you have affiliated entities</summary>
                           <div data-ajax-replace="who-apply.html #affiliated"></div>
                        </details>
                           <!--
                           <p><a href="#affiliated-entities" aria-controls="lwp" class="wb-lbx" role="button">Find out if you have affiliated businesses or entities<span class="far fa-question-circle"></span></a></p>
                           <section id="affiliated-entities" class="mfp-hide modal-dialog modal-content overlay-def">
                              <header class="modal-header">
                                 <h2 class="modal-title">Affiliated businesses or entities</h2>
                              </header>
                              <div class="modal-body">
                                <p>An affiliated entity is an organization that:</p>
                                <ul>
                                <li>controls another entity (directly or indirectly)</li>
                                <li>is controlled by another entity (directly or indirectly)</li>
                                <li>is under common control alongside another entity</li>
                                </ul>

                                <p>Although the rules can be complicated, some examples include:</p>
                                <ul>
                                <li>you run your business activities through more than one entity (corporations, trusts or partnerships)</li>
                                <li>you and your spouse each own or operate a business, directly or through a corporation or other entity </li>
                                <li>the entity through which your business or activities are conducted is owned or controlled by people who own or control other entities </li>
                                </ul>
                              </div>
                           </section>
                         -->
                           <fieldset class="provisional gc-chckbxrdio chckbxrdio-grp">
                              <legend>Do you have affiliated entities that are also applying for CERS for this claim period?</legend>
                              <!-- this location closed for over 1 week during the period due to a COVID-19 public health restriction? -->
                              <ul class="list-unstyled lst-spcd-2">
                                 <li class="radio">
                                    <input type="radio" name="affiliated" id="affiliated-yes" class="valid" aria-invalid="false">
                                    <label for="affiliated-yes">Yes </label>
                                 </li>
                                 <li class="radio">
                                    <input type="radio" name="affiliated" id="affiliated-no" class="valid" aria-invalid="false">
                                    <label for="affiliated-no">No </label>
                                 </li>
                              </ul>
                           </fieldset>
                           <div id="affiliated-split-input" class="hidden">
                              <div class="form-group row mrgn-tp-lg mrgn-bttm-0">
                                 <div class="col-md-12">
                                    <label for="affiliated-split" class="required">Percentage that your business agreed to claim<span class="wb-inv"> (do not include a
                                    dollar sign, spaces or commas)</span><strong class="required">(required)</strong></label>
                                 </div>
                                 <div class="col-md-6">
                                    <div class="input-group"> <span class="input-group-addon input-sm">%</span>
                                       <input type="number" class="form-control text-right percentage" id="affiliated-split" max="100" min="0">
                                    </div>
                                 </div>
                              </div>
                           </div>
                           <hr class="brdr-bttm">
                           <div class="well mrgn-tp-md mrgn-bttm-lg">
                              <h3 class="mrgn-tp-0">Summary of Step 2</h3>
                              <ul class="list-unstyled lst-spcd">
                                 <li class="affiliated-no-answer">You have indicated you do not have any affiliated entities that are claiming the CERS for this claim period.</li>
                                 <li class="affiliated-yes-blank-answer hidden">Affiliated entities must agree on how they will split the $300,000 eligible expenses maximum, even if they do not reach the maximum.</li>
                                 <li class="affiliated-yes-answer hidden">Percentage your business will claim of the eligible expense maximum: <span class="h3 affiliated-entity-percentage">0%</span> (you can claim up to <span id="affiliated-max-amount">$0.00</span>)</li>
                                 <li class="affiliated-yes-answer hidden">Other affiliated entities will be able to claim up to <span id="affiliated-remaining">0%</span></li>
                              </ul>
                           </div>
                        </fieldset>
                     </li>
                     <li>
                        <fieldset class="brdr-tp">
                          <legend><span class="wb-inv">Step 3: </span>Calculate your rent subsidy rate</legend>
                          <div class="clearfix"></div>
                          <p>The amount of your eligible expenses you can claim is determined by your revenue drop.</p>
                          <div class="provisional alert alert-danger" id="select-a-claim-period-reminder">
                            <p>You must select a Claim period in <a href="#claim-period">Step 1</a> before you can complete this step.</p>
                          </div>
                          <fieldset class="brdr-0 hidden" id="rate-reduction">
                              <details>
                                <summary>Compare the baseline revenue options</summary>
                                <p>Baseline revenue and prior reference period options</p>
                                <p>Your baseline revenue is determined by the prior reference period you choose. It is either:</p>
                                <div class="row">
                                  <div class="col-xs-12">
                                     <div class="row">
                                        <div class="col-xs-12 col-sm-6 brdr-rght mrgn-bttm-lg">
                                           <div class="col-sm-12">
                                              <p class="mrgn-tp-0 h5 text-muted">General prior reference period</p>
                                              <p>The eligible revenue you earned in the <strong>corresponding month in 2019</strong></p>
                                           </div>
                                        </div>
                                        <div class="col-xs-1 col-sm-12 pstn-tp-sm text-center mrgn-bttm-lg"><span class="fa-stack fa-fw text-muted"> <span class="fas fa-circle fa-stack-2x"></span><span class="fa-stack-1x fa-inverse">or</span></span></div>
                                        <div class="col-xs-12 col-sm-6 mrgn-bttm-lg">
                                           <div class="col-sm-12">
                                              <p class="mrgn-tp-0 h5 text-muted">Alternative prior reference period</p>
                                              <p>The average of the eligible revenue you earned in January and February 2020</p>
                                           </div>
                                        </div>
                                     </div>
                                  </div>
                               </div>
                                <p>You must choose one of these prior reference period options and use it when calculating your revenue drop for the base rate for all claim periods. If you have also claimed the CEWS, the method you use must be the same as the method you used for CEWS periods 5 or later.</p>
                                <p><strong>Note: </strong>If you choose to use the alternative prior reference period (January and February 2020), you need to check the "prior reference period" election box when completing your CERS application form.</p>
                              </details>
                              <div class="wb-fieldflow" data-wb-fieldflow='{"isoptional": true, "noForm": true }'>
                                 <p>Which baseline revenue comparison option will you use for this claim (you must use the same option as other CERS or CEWS claims)?</p>
                                 <ul>
                                    <li data-wb-fieldflow='{"action": "toggle", "toggle": "#alt-bl-no", "live": true}'>
                                       Compare 2019 month with claim month
                                    </li>
                                    <li data-wb-fieldflow='{"action": "toggle", "toggle": "#alt-bl-yes", "live": true}'>
                                       Average of January and February 2020 (alternative baseline revenue)
                                    </li>
                                 </ul>
                              </div>
                           </fieldset>
                           <div class="hidden" id="alt-bl-no">
                              <fieldset>
                                 <legend class="mrgn-bttm-0">Enter your eligible revenue for the following months</legend>
                                 <p><a class="wb-lbx" role="button" aria-controls="eligible-rev"
                                    href="#eligible-rev">Eligible revenue<span
                                    class="mrgn-lft-sm far fa-question-circle"></span></a></p>
                                 <!-- <p class="text-info">If you are applying for CEWS for the same period, you must do so before applying for CERS, and include your CEWS claim amount as revenue.</p> -->
                                 <p class="small text-muted mrgn-tp-lg" aria-hidden="true">Do not include <strong>spaces,
                                    commas,</strong> or a <strong>dollar sign</strong>
                                 </p>
                                 <div class="row">
                                    <div class="col-md-6 brdr-rght">
                                       <p><strong>2019 revenue</strong></p>
                                       <div class="form-group row">
                                          <label class="col-sm-6 control-label" for="2019-09-no">September 2019<span class="wb-inv"> (do not include a dollar sign, spaces or commas)</span></label>
                                          <div class="col-sm-6">
                                             <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                <input type="number" class="form-control text-right cers-rate-calc currency" name="2019-09-no" id="2019-09-no" size="10" placeholder="0.00">
                                             </div>
                                          </div>
                                       </div>
                                       <div class="form-group row">
                                          <label class="col-sm-6 control-label" for="2019-10-no">October 2019<span
                                             class="wb-inv"> (do not include a
                                          dollar sign, spaces or commas)</span></label>
                                          <div class="col-sm-6">
                                             <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                <input type="number" class="form-control text-right cers-rate-calc currency"
                                                   name="2019-10-no" id="2019-10-no" size="10" placeholder="0.00">
                                             </div>
                                          </div>
                                       </div>
                                       <div class="form-group row">
                                          <label class="col-sm-6 control-label" for="2019-11-no">November 2019<span
                                             class="wb-inv"> (do not include a
                                          dollar sign, spaces or commas)</span></label>
                                          <div class="col-sm-6">
                                             <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                <input type="number" class="form-control text-right cers-rate-calc currency"
                                                   name="2019-11-no" id="2019-11-no" size="10" placeholder="0.00">
                                             </div>
                                          </div>
                                       </div>
                                       <div class="form-group row">
                                          <label class="col-sm-6 control-label" for="2019-12-no">December 2019<span
                                             class="wb-inv"> (do not include a
                                          dollar sign, spaces or commas)</span></label>
                                          <div class="col-sm-6">
                                             <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                <input type="number" class="form-control text-right cers-rate-calc currency"
                                                   name="2019-12-no" id="2019-12-no" size="10" placeholder="0.00">
                                             </div>
                                          </div>
                                       </div>
                                    </div>
                                    <div class="col-md-6">
                                       <p><strong>2020 revenue</strong></p>
                                       <div class="form-group row">
                                          <label class="col-sm-6 control-label" for="2020-09-no">September 2020<span
                                             class="wb-inv"> (do not include a
                                          dollar sign, spaces or commas)</span></label>
                                          <div class="col-sm-6">
                                             <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                <input type="number" class="form-control text-right cers-rate-calc currency"
                                                   name="2020-09-no" id="2020-09-no" size="10" placeholder="0.00">
                                             </div>
                                          </div>
                                       </div>
                                       <div class="form-group row">
                                          <label class="col-sm-6 control-label" for="2020-10-no">October 2020<span
                                             class="wb-inv"> (do not include a
                                          dollar sign, spaces or commas)</span></label>
                                          <div class="col-sm-6">
                                             <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                <input type="number" class="form-control text-right cers-rate-calc currency"
                                                   name="2020-10-no" id="2020-10-no" size="10" placeholder="0.00">
                                             </div>
                                          </div>
                                       </div>
                                       <div class="form-group row">
                                          <label class="col-sm-6 control-label" for="2020-11-no">November 2020<span
                                             class="wb-inv"> (do not include a
                                          dollar sign, spaces or commas)</span></label>
                                          <div class="col-sm-6">
                                             <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                <input type="number" class="form-control text-right cers-rate-calc currency"
                                                   name="2020-11-no" id="2020-11-no" size="10" placeholder="0.00">
                                             </div>
                                          </div>
                                       </div>
                                       <div class="form-group row">
                                          <label class="col-sm-6 control-label" for="2020-12-no">December 2020<span
                                             class="wb-inv"> (do not include a
                                          dollar sign, spaces or commas)</span></label>
                                          <div class="col-sm-6">
                                             <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                <input type="number" class="form-control text-right cers-rate-calc currency"
                                                   name="2020-12-no" id="2020-12-no" size="10" placeholder="0.00">
                                             </div>
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                              </fieldset>
                              <a class="btn btn-default">Update your revenue drop</a>
                           </div>
                           <div class="hidden" id="alt-bl-yes">
                              <fieldset>
                                 <legend class="mrgn-bttm-0">Enter your eligible revenue for the following months</legend>
                                 <p><a class="wb-lbx" role="button" aria-controls="eligible-rev"
                                    href="#eligible-rev">Eligible revenue<span
                                    class="mrgn-lft-sm far fa-question-circle"></span></a></p>
                                 <!-- <p class="text-info">If you are applying for CEWS for the same period, you must do so before applying for CERS, and include your CEWS claim amount as revenue.</p> -->
                                 <p class="small text-muted  mrgn-tp-lg" aria-hidden="true">Do not include <strong>spaces,
                                    commas,</strong> or a <strong>dollar sign</strong>
                                 </p>
                                 <div class="row">
                                    <div class="col-md-6">
                                       <div class="form-group row">
                                          <label class="col-sm-6 control-label" for="2020-01-yes">January 2020<span
                                             class="wb-inv"> (do not include a
                                          dollar sign, spaces or commas)</span></label>
                                          <div class="col-sm-6">
                                             <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                <input type="number" class="form-control text-right cers-rate-calc-alt currency"
                                                   name="2020-01-yes" id="2020-01-yes" size="10" placeholder="0.00">
                                             </div>
                                          </div>
                                       </div>
                                       <div class="form-group row">
                                          <label class="col-sm-6 control-label" for="2020-02-yes">February 2020<span
                                             class="wb-inv"> (do not include a
                                          dollar sign, spaces or commas)</span></label>
                                          <div class="col-sm-6">
                                             <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                <input type="number" class="form-control text-right cers-rate-calc-alt currency"
                                                   name="2020-02-yes" id="2020-02-yes" size="10" placeholder="0.00">
                                             </div>
                                          </div>
                                       </div>
                                       <div class="form-group row">
                                          <label class="col-sm-6 control-label" for="2020-09-yes">September 2020<span
                                             class="wb-inv"> (do not include a
                                          dollar sign, spaces or commas)</span></label>
                                          <div class="col-sm-6">
                                             <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                <input type="number" class="form-control text-right cers-rate-calc-alt currency"
                                                   name="2020-09-yes" id="2020-09-yes" size="10" placeholder="0.00">
                                             </div>
                                          </div>
                                       </div>
                                       <div class="form-group row">
                                          <label class="col-sm-6 control-label" for="2020-10-yes">October 2020<span
                                             class="wb-inv"> (do not include a
                                          dollar sign, spaces or commas)</span></label>
                                          <div class="col-sm-6">
                                             <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                <input type="number" class="form-control text-right cers-rate-calc-alt currency"
                                                   name="2020-10-yes" id="2020-10-yes" size="10" placeholder="0.00">
                                             </div>
                                          </div>
                                       </div>
                                       <div class="form-group row">
                                          <label class="col-sm-6 control-label" for="2020-11-yes">November 2020<span
                                             class="wb-inv"> (do not include a
                                          dollar sign, spaces or commas)</span></label>
                                          <div class="col-sm-6">
                                             <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                <input type="number" class="form-control text-right cers-rate-calc-alt currency"
                                                   name="2020-11-yes" id="2020-11-yes" size="10" placeholder="0.00">
                                             </div>
                                          </div>
                                       </div>
                                       <div class="form-group row">
                                          <label class="col-sm-6 control-label" for="2020-12-yes">December 2020<span
                                             class="wb-inv"> (do not include a
                                          dollar sign, spaces or commas)</span></label>
                                          <div class="col-sm-6">
                                             <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                <input type="number" class="form-control text-right cers-rate-calc-alt currency"
                                                   name="2020-12-yes" id="2020-12-yes" size="10" placeholder="0.00">
                                             </div>
                                          </div>
                                       </div>
                                    </div>
                                 </div>
                              </fieldset>
                              <a class="btn btn-default">Update your revenue drop</a>
                           </div>
                           <div id="revenue-drop-results-summary" class="well mrgn-tp-md">
                              <h3 class="mrgn-tp-0">Summary of Step 3</h3>
                              <ul class="small">
                                <li>Your <strong>current period revenue drop</strong> is <span
                                  class="h4 currentRevReduction">0%</span></li>
                                <li class="brdr-bttm">Your <strong>previous period revenue drop</strong> is <span
                                  class="priorRevReduction h4">0%</span></li>
                                <p>Because the higher of these revenue drops is <span class="h4 preferentialRevReduction">0%</span>, your rate is calculated as <span id="rate-formula-max" class="hidden">the maximum</span><span id="rate-formula-u70" class="hidden">(your revenue drop - 50%) x 1.25 + 40%</span><span id="rate-formula-u50" class="hidden">your revenue drop x 0.8</span><span id="rate-formula-0">0</span>.</p>
                                <p>Your rent subsidy rate is <span class="h3 mrgn-tp-0 base-rate">0%</span></p>
                              </ul>
                           </div>
                        </fieldset>
                     </li>
                     <li>
                        <fieldset class="brdr-tp">
                           <legend><span class="wb-inv">Step 4: </span>Your business locations</legend>
                           <div class="clearfix"></div>
                           <p>The CERS amount you can apply for is a percentage of your eligible expenses for all your business locations. (<span class="base-rate">0%</span>).</p>
                           <p>Each location is eligible to claim up to $75,000 in eligible expenses.</p>
                          <!-- <p>The base subsidy amount you can get is based on your CERS rate (<span class="base-rate">0%</span>) as a portion of eligible expenses, up to a maximum amountof $300,000.</p>-->
                           <div class="mrgn-tp-lg">
                              <div id="cers-calculation" class=" panel panel-primary panel-body" aria-live="polite">
                                 <p class="h4 mrgn-tp-0">Lockdown support and eligible expenses</p>
                                 <fieldset id="locations">
                                    <legend>Calculate your lockdown support rates and eligible expenses</legend>
                                    <p>Include all your business locations.</p>
                                    <fieldset class="panel panel-default" id="loc-1">
                                       <legend class="col-xs-7 col-sm-9 mrgn-tp-md"><span class="fas fa-building"></span>
                                          Business location <span class="locationNumber">1</span>
                                       </legend>
                                       <button class="col-xs-4 col-sm-2 btn btn-xs btn-danger pull-right rm-loc hidden mrgn-rght-md mrgn-tp-md" type="button">Remove</button>
                                       <div class="clearfix"></div>
                                       <div class="panel-body">
                                          <div class="form-group">
                                             <div id="loc-address-1" class="row loc-address">
                                                <div class="col-md-12">
                                                   <label for="loc-staddress-1">Street address</label>
                                                   <input type="text" size="50" class="form-control input-lg" id="loc-staddress-1">
                                                </div>
                                                <div class="col-xs-4">
                                                   <label for="loc-city-1">City</label>
                                                   <input type="text" class="form-control input-lg" id="loc-city-1">
                                                </div>
                                                <div class="col-xs-5 col-sm-3">
                                                   <label for="loc-prov-1">Prov.</label>
                                                   <select class="form-control input-lg" id="loc-prov-1">
                                                      <option>--</option>
                                                      <option>AB</option>
                                                      <option>BC</option>
                                                      <option>MB</option>
                                                      <option>NB</option>
                                                      <option>NL</option>
                                                      <option>NT</option>
                                                      <option>NS</option>
                                                      <option>NU</option>
                                                      <option>ON</option>
                                                      <option>PE</option>
                                                      <option>QC</option>
                                                      <option>SK</option>
                                                      <option>YT</option>
                                                   </select>
                                                </div>
                                                <div class="col-xs-5 col-sm-4">
                                                   <label for="loc-postcode-1">Postal code</label>
                                                   <input type="text" class="form-control input-lg" id="loc-postcode-1" maxlength="6" size="11">
                                                </div>
                                             </div>
                                          </div>
                                          <fieldset>
                                             <legend class="mrgn-bttm-0">Calculate your lockdown support rate</legend>
                                             <!-- <p>If your business location was closed due to government COVID-19 restrictions in this region, indicate the start and end dates of the restrictions.</p> -->
                                             <div class="clearfix"></div>
                                             <fieldset class="provisional gc-chckbxrdio chckbxrdio-grp">
                                              <legend>Does the location qualify for lockdown support?</legend>
                                              <details>
                                                <summary class="lockdown-details">To qualify for lockdown support</summary>
                                                <p>Lockdown support (the top-up) is applied on a location by location basis.</p>
                                                <p>The business location must meet all the following conditions to qualify for the top up:</p>
                                                <ul class="fa-ul">
                                                  <li><span class="fas fa-check text-success fa-li"></span>the business was forced to cease some or all of its activities in the location for at least one week as a result of a <strong>COVID related public health order</strong></li>
                                                  <li><span class="fas fa-check text-success fa-li"></span>the public health order affected a clearly defined geographical region where the business operates, as well as the types of activities that were restricted</li>
                                                  <li><span class="fas fa-check text-success fa-li"></span>the order came from a federal, provincial or municipal government, or a local health authority</li>
                                                  <li><span class="fas fa-check text-success fa-li"></span>the <strong>activities the business was restricted from carrying out</strong> must account for at least 25% of total revenues at that location during the 'prior reference period' (month preceding the claim period)</li>
                                                  <li><span class="fas fa-check text-success fa-li"></span>activities at the location must not already be restricted as a direct result of a failure to comply with a previous public health order or decision</li>
                                                  <li><span class="fas fa-check text-success fa-li"></span>the business qualifies for a base CERS subsidy rate more than 0% for the period</li>
                                                </ul>
                                                <p>Note that the public health order must be a cessation of activities. Ordered reduction in operating hours or capacity, or similar restriction such as the following would not qualify:</p>
                                                <ul class="fa-ul">
                                                  <li><span class="fas fa-times text-danger fa-li"></span>a restriction on how the activity is performed (e.g., mask requirement for indoor dining servers)</li>
                                                  <li><span class="fas fa-times text-danger fa-li"></span>a restriction on the time during which the activity may be performed (e.g., a required reduction in service hours)</li>
                                                  <li><span class="fas fa-times text-danger fa-li"></span>any other restrictions that do not specifically require a cease of activities (e.g., a requirement to reducing seating capacity for indoor dining services</li>
                                                </ul>
                                              </details>
                                              <ul class="list-unstyled lst-spcd-2">
                                                <li class="radio">
                                                  <input type="radio" name="lock-down-1" id="lock-down-yes-1">
                                                  <label for="lock-down-yes-1">Yes</label>
                                                </li>
                                                <li class="radio">
                                                  <input type="radio" name="lock-down-1" id="lock-down-no-1">
                                                  <label for="lock-down-no-1">No</label>
                                                </li>
                                              </ul>
                                             </fieldset>
                                             <div id="lock-down-period-1" class="lock-down-dates hidden">
                                                <div class="row">
                                                   <div class="col-sm-6">
                                                      <div class="form-group">
                                                          <label for="lockdown-start-1">Lockdown start date<span class="datepicker-format"> (<abbr title="Four digits year, dash, two digits month, dash, two digits day">YYYY-MM-DD</abbr>)</span></label>
                                                          <div class="lockdown-start-datepicker-init">
                                                            <input class="form-control lockdown-start-date" type="date" id="lockdown-start-1" name="lockdown-start-1" min="2020-09-27" value="2020-09-27" max="2020-10-24" />
                                                          </div>
                                                      </div>
                                                   </div>
                                                   <div class="col-sm-6">
                                                      <div class="form-group">
                                                          <label for="lockdown-end-1">Lockdown end date<span class="datepicker-format"> (<abbr title="Four digits year, dash, two digits month, dash, two digits day">YYYY-MM-DD</abbr>)</span></label>
                                                          <div class="lockdown-end-datepicker-init">
                                                            <input class="form-control lockdown-end-date" type="date" id="lockdown-end-1" name="lockdown-end-1" min="2020-09-27" value="2020-10-24" max="2020-10-24" />
                                                          </div>
                                                      </div>
                                                   </div>
                                                </div>
                                                <!-- For edge? Manual input
                                                <div id="lockdown-manual-1">
                                                  <div class="row">
                                                    <div class="fieldset">
                                                      <div class="col-md-12">
                                                        <legend>Lockdown start date<span class="wb-inv"> (<abbr title="Select month and input two digits day">Month D</abbr>)</span></legend>
                                                        <div class="row">
                                                          <div class="col-xs-6 col-sm-4">
                                                            <div class="form-group">
                                                              <label for="lockdown-manual-start-month-1">Month</label>
                                                              <select class="form-control input-lg" id="lockdown-manual-start-month-1">
                                                                  <option class="claim-month-one">September 2020</option>
                                                                  <option class="claim-month-two">October 2020</option>
                                                              </select>
                                                            </div>
                                                          </div>
                                                          <div class="col-xs-6 col-sm-2">
                                                            <div class="form-group">
                                                              <label for="lockdown-manual-start-day-1">Day</label>
                                                              <input type="number" class="form-control day input-lg" id="lockdown-manual-start-day-1" min="2" max="20">
                                                            </div>
                                                          </div>
                                                        </div>
                                                      </div>
                                                    </div>
                                                  </div>
                                                </div> -->

                                                <a class="btn btn-default">Update your lockdown support</a>
                                              </div>
                                              <div class="well mrgn-tp-md">
                                                  <h3 class="mrgn-tp-0">Lockdown support rate summary</h3>
                                                  <p id="lock-down-ineligible-1">You do not qualify for a lockdown support. To qualify, the location must have been closed due to COVID-19 restrictions for <strong>more than 1 week</strong>.</p>
                                                  <p id="lock-down-eligible-1" class="hidden">Because your location was closed due to imposed COVID-19 restrictions for <span id="top-up-days-1" class="h4">0</span> days, your lockdown support rate is <span class="h4 mrgn-tp-0 top-up-rate-1">0%</span></p>
                                              </div>

                                             <fieldset class="provisional gc-chckbxrdio chckbxrdio-grp">
                                                <legend>Do you rent or own this property?</legend>
                                                <ul class="list-unstyled lst-spcd-2">
                                                  <li class="radio">
                                                    <input type="radio" name="owner-location-1" id="owner-location-no-1">
                                                    <label for="owner-location-no-1">Rent</label>
                                                 </li>
                                                 <li class="radio">
                                                      <input type="radio" name="owner-location-1" id="owner-location-yes-1">
                                                      <label for="owner-location-yes-1">Own</label>
                                                   </li>
                                                </ul>
                                             </fieldset>
                                             <div id="choose-own-or-rent-message-1" class="provisional alert alert-danger">
                                              <p>First select whether you own or rent this property</p>
                                            </div>
                                             <div class="rent-location-1 hidden">

                                              <fieldset class="provisional gc-chckbxrdio chckbxrdio-grp">
                                                <div class="col-sm-12">
                                                  <label for="calc-method-1">Are your rent and any rental income for this location paid monthly? </label>
                                                  <select class="form-control input-lg valid" id="calc-method-1">
                                                    <option data-calc-method="month">Yes - calculate monthly</option>
                                                    <option data-calc-method="period">No - manually input 28 day amounts</option>
                                                  </select>
                                                </div>
                                              </fieldset>
                                              <div class="alert alert-info provisional month-one-1 mrgn-tp-md mrgn-bttm-0">
                                                <p>If you use this monthly option, all expense payments must be in respect of the calendar month.</p>
                                              </div>

                                              <legend class="mrgn-bttm-0 month-one-1">Monthly eligible expenses for <span class="claim-month-one">month 1</span></legend>
                                              <div class="clearfix"></div>

                                              <!-- *****
                                              Month one rent starts here
                                              ***** -->
                                              <div class="form-group row mrgn-bttm-0 month-one-1">
                                                <p class="small text-muted mrgn-bttm-0" aria-hidden="true">Do not include <strong>spaces, commas,</strong> or a <strong>dollar sign</strong></p>

                                                <div class="col-md-6 col-sm-12">
                                                  <label for="rent-one-1">Rent<span class="wb-inv"> (do not include a dollar sign, spaces or commas)</span> </label>
                                                  <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                    <input type="number" class="form-control text-right currency rent-expense-1" id="rent-one-1" placeholder="0.00" data-updates="rent-amt-1" aria-describedby="rent-one-date-1">
                                                  </div>
                                                  <p id="rent-one-date-1" class="text-muted small">from <span class="date-month-one-start">[Start]</span> to <span class="date-month-one-end">[End]</span></p>
                                                </div>

                                                <div class="clearfix"></div>
                                                <!-- <p>Expenses <span class="fas fa-minus"></span></p> -->
                                                <div class="col-md-6 col-sm-12">
                                                  <label for="lease-one-1">Rental income<span class="wb-inv"> (do not include a dollar sign, spaces or commas)</span> </label>
                                                  <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                    <input type="number" class="form-control text-right currency rent-expense-1" id="lease-one-1" placeholder="0.00" data-updates="lease-amt-1" aria-describedby="lease-one-date-1">
                                                  </div>
                                                  <p id="lease-one-date-1" class="text-muted small">from <span class="date-month-one-start">[Start]</span> to <span class="date-month-one-end">[End]</span></p>
                                                </div>
                                              </div>

                                              <!-- *****
                                              Month two rent starts here
                                              ***** -->
                                              <div class="month-two-1">
                                                <legend class="mrgn-bttm-0">Monthly eligible expenses for <span class="claim-month-two">month 2</span></legend>
                                                <div class="form-group row mrgn-bttm-0">
                                                  <div class="col-md-6 col-sm-12">
                                                    <label for="rent-two-1">Rent<span class="wb-inv"> (do not include a dollar sign, spaces or commas)</span> </label>
                                                    <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                      <input type="number" class="form-control text-right rent-expense-1 currency" id="rent-two-1" placeholder="0.00" data-updates="rent-amt-1" aria-describedby="rent-two-date-1">
                                                    </div>
                                                    <p id="rent-two-date-1" class="text-muted small">from <span class="date-month-two-start">[Start]</span> to <span class="date-month-two-end">[End]</span></p>
                                                  </div>

                                                  <div class="clearfix"></div>
                                                  <!-- <p>Expenses <span class="fas fa-minus"></span></p> -->
                                                  <div class="col-md-6 col-sm-12">
                                                    <label for="lease-two-1">Rental income<span class="wb-inv"> (do not include a dollar sign, spaces or commas)</span> </label>
                                                    <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                      <input type="number" class="form-control text-right rent-expense-1 currency" id="lease-two-1" placeholder="0.00" data-updates="lease-amt-1" aria-describedby="lease-two-date-1">
                                                    </div>
                                                    <p id="lease-two-date-1" class="text-muted small">from <span class="date-month-two-start">[Start]</span> to <span class="date-month-two-end">[End]</span></p>
                                                  </div>
                                                </div>
                                              </div>

                                              <div class="cers-period-1 hidden">
                                                <p class="small text-muted mrgn-bttm-0" aria-hidden="true">Do not include <strong>spaces, commas,</strong> or a <strong>dollar sign</strong></p>

                                                <legend class="mrgn-bttm-0 mrgn-tp-lg">Monthly eligible expenses for the claim period</legend>
                                                <div class="form-group row mrgn-bttm-0">
                                                  <div class="col-md-6 col-sm-12">
                                                    <label for="rent-cers-period-1">Rent<span class="wb-inv"> (do not include a dollar sign, spaces or commas)</span> </label>
                                                    <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                      <input type="number" class="form-control text-right rent-expense-1 currency valid" id="rent-cers-period-1" placeholder="0.00" data-updates="rent-amt-1" aria-describedby="rent-cers-period-date-1">
                                                    </div>
                                                    <p id="rent-cers-period-date-1" class="text-muted small">from <span class="date-cers-period-start">[Start]</span> to <span class="date-cers-period-end">[End]</span></p>
                                                  </div>

                                                  <div class="clearfix"></div>
                                                  <!-- <p>Expenses <span class="fas fa-minus"></span></p> -->
                                                  <div class="col-md-6 col-sm-12">
                                                    <label for="lease-cers-period-1">Rental income<span class="wb-inv"> (do not include a dollar sign, spaces or commas)</span> </label>
                                                    <div class="input-group"> <span class="input-group-addon input-sm">$</span>
                                                      <input type="number" class="form-control text-right rent-expense-1 currency" id="lease-cers-period-1" placeholder="0.00" data-updates="lease-amt-1" aria-describedby="lease-cers-period-date-1">
                                                    </div>
                                                    <p id="lease-cers-period-date-1" class="text-muted small">from <span class="date-cers-period-start">[Start]</span> to <span class="date-cers-period-end">[End]</span></p>
                                                  </div>
                                                </div>
                                              </div>

                                            </div>

                                            <!-- This is where the Owned location inputs start -->
                                            <div class="own-location-1 hidden">

                                              <legend class="mrgn-bttm-0 month-one-1">Eligible expenses for the claim period</legend>
                                              <div class="row">

                                                <div class="col-md-12 mrgn-tp-md">
                                                  <p class="small text-muted mrgn-bttm-0" aria-hidden="true">Do not include <strong>spaces, commas,</strong> or a <strong>dollar sign</strong></p>
                                                  <p class="small text-muted mrgn-bttm-0" aria-hidden="true">Adjust your amounts for the CERS period (28 days) option if your expense payment periods don't align with the monthly or yearly options.</p>

                                                  <label for="tax-own-1">Property taxes<span class="wb-inv"> (do not include a dollar sign, spaces or commas)</span> </label>
                                                  <fieldset class="provisional gc-chckbxrdio chckbxrdio-grp">
                                                    <div class="input-group">
                                                      <label for="date-chooser-tax-1" class="wb-inv">The period for which the tax payment was made</label>
                                                      <select class="form-control input-lg" id="date-chooser-tax-1">
                                                        <option data-calc-method="none">Select an expense period</option>
                                                        <option data-calc-method="period">CERS period (28 days)</option>
                                                        <option data-calc-method="month">Per month</option>
                                                        <option data-calc-method="year">Year 2020</option>
                                                      </select>
                                                      <span class="input-group-addon input-sm">$</span>
                                                      <input type="number" class="form-control text-right rent-expense-1 currency" style="height:46px;" id="tax-own-1" placeholder="0.00" data-updates="tax-amt-1" aria-describedby="tax-date-1">
                                                    </div>
                                                    <p id="tax-date-error-1" class="text-info text-right small">Select an expense period first</p>
                                                    <p id="tax-date-1" class="hidden text-muted text-right small">from <span class="date-tax-start-1"><span class="date-cers-period-start">[Start]</span></span> to <span class="date-tax-end-1"><span class="date-cers-period-end">[End]</span></span></p>
                                                  </fieldset>
                                                </div>

                                                <div class="col-md-12">
                                                  <label for="insurance-own-1">Property insurance<span class="wb-inv"> (do not include a dollar sign, spaces or commas)</span> </label>
                                                  <fieldset class="provisional gc-chckbxrdio chckbxrdio-grp">
                                                    <div class="input-group">
                                                      <label for="date-chooser-insurance-1" class="wb-inv">The period for which the insurance payment was made</label>
                                                      <select class="form-control input-lg" id="date-chooser-insurance-1">
                                                        <option data-calc-method="none">Select an expense period</option>
                                                        <option data-calc-method="period">CERS period (28 days)</option>
                                                        <option data-calc-method="month">Per month</option>
                                                        <option data-calc-method="year">Year 2020</option>
                                                      </select>
                                                      <span class="input-group-addon input-sm">$</span>
                                                      <input type="number" class="form-control text-right rent-expense-1 currency" style="height:46px;" id="insurance-own-1" placeholder="0.00" data-updates="insurance-amt-1" aria-describedby="insurance-date-1">
                                                    </div>
                                                    <p id="insurance-date-error-1" class="text-info text-right small">Select an expense period first</p>
                                                    <p id="insurance-date-1" class="hidden text-muted text-right small">from <span class="date-insurance-start-1"><span class="date-cers-period-start">[Start]</span></span> to <span class="date-insurance-end-1"><span class="date-cers-period-end">[End]</span></span></p>
                                                  </fieldset>
                                                </div>

                                                <div class="col-md-12 mrgn-tp-md">
                                                  <label for="interest-own-1">Interest on commercial mortgages<span class="wb-inv"> (do not include a dollar sign, spaces or commas)</span> </label>
                                                  <fieldset class="provisional gc-chckbxrdio chckbxrdio-grp">
                                                    <div class="input-group">
                                                      <label for="date-chooser-interest-1" class="wb-inv">The period for which the interest payment was made</label>
                                                      <select required class="form-control input-lg" id="date-chooser-interest-1">
                                                        <option data-calc-method="none">Select an expense period</option>
                                                        <option data-calc-method="period">CERS period (28 days)</option>
                                                        <option data-calc-method="month">Per month</option>
                                                      </select>
                                                      <span class="input-group-addon input-sm">$</span>
                                                      <input type="number" class="form-control text-right rent-expense-1 currency" style="height:46px;" id="interest-own-1" placeholder="0.00" data-updates="interest-amt-1" aria-describedby="interest-date-1">
                                                    </div>
                                                    <p id="interest-date-error-1" class="text-info text-right small">Select an expense period first</p>
                                                    <p id="interest-date-1" class="hidden text-muted text-right small">from <span class="date-interest-start-1"><span class="date-cers-period-start">[Start]</span></span> to <span class="date-interest-end-1"><span class="date-cers-period-end">[End]</span></span></p>
                                                  </fieldset>
                                                </div>


                                                <div class="col-md-12 mrgn-tp-lg">
                                                  <label for="lease-own-1">Rental income<span class="wb-inv"> (do not include a dollar sign, spaces or commas)</span> </label>
                                                  <fieldset class="provisional gc-chckbxrdio chckbxrdio-grp form-group">
                                                    <div class="input-group">
                                                      <label for="date-chooser-lease-1" class="wb-inv">The period for which the lease payment was made</label>
                                                      <select class="form-control input-lg" id="date-chooser-lease-1">
                                                        <option data-calc-method="none">Select an expense period</option>
                                                        <option data-calc-method="period">CERS period (28 days)</option>
                                                        <option data-calc-method="month">Per month</option>
                                                      </select>
                                                      <span class="input-group-addon input-sm">$</span>
                                                      <input type="number" class="form-control text-right rent-expense-1 currency" style="height:46px;" id="lease-own-1" placeholder="0.00" data-updates="lease-amt-1" aria-describedby="lease-date-1">
                                                    </div>
                                                    <p id="lease-date-error-1" class="text-info text-right small">Select an expense period first</p>
                                                    <p id="lease-date-1" class="hidden text-muted text-right small">from <span class="date-lease-start-1"><span class="date-cers-period-start">[Start]</span></span> to <span class="date-lease-end-1"><span class="date-cers-period-end">[End]</span></span></p>
                                                  </fieldset>
                                                </div>
                                              </div>
                                            </div>
                                          </fieldset>
                                        </div>
                                       <!-- Formula:
                                          max(Rent, sum(tax, interest, insurance), 75k)
                                          - sub-letting
                                          = qualifying rent expense (QRE)
                                          base * QRE + top-up * QRE


                                          line 160 = cummulative rent expense (from all the properties)

                                          cummulative base CERS, max 300k

                                          F is 0 if base is 0

                                          + cummmulative top up CERS = F (Top up rate for property) * G (QRE)
                                          = CERS

                                          unless other affiliated entities, in which case...
                                          if (300k or over) {
                                            300k * affiliated entities cut
                                            = CERS
                                          }
                                           -->
                                       <footer class="panel-footer">
                                          <details class="smry-accordion-details" open>
                                             <summary class="location-details">Expense summary for <span class="loc-staddress-1">location 1</span>
                                             </summary>
                                             <table class="table table-condensed small" id="loc-smry-1">
                                                <caption class="wb-inv">
                                                  Expense summary for <span class="loc-staddress-1">location 1</span>
                                                </caption>
                                                <thead>
                                                   <tr>
                                                      <th scope="col">Type of expense</th>
                                                      <th scope="col">Amount</th>
                                                   </tr>
                                                </thead>
                                                <tbody>
                                                  <tr class="rent-location-1">
                                                    <td>Rent</td>
                                                    <td data-updates="rent-ttl-1" id="rent-amt-1">$0.00</td>
                                                  </tr>
                                                  <tr class="own-location-1">
                                                    <td>Property tax</td>
                                                    <td data-updates="tax-ttl-1" id="tax-amt-1">$0.00</td>
                                                  </tr>
                                                  <tr class="own-location-1">
                                                    <td>Property insurance</td>
                                                    <td data-updates="insurance-ttl-1" id="insurance-amt-1">$0.00</td>
                                                  </tr>
                                                  <tr class="own-location-1">
                                                    <td>Interest on commercial mortgages</td>
                                                    <td data-updates="interest-ttl-1" id="interest-amt-1">$0.00</td>
                                                  </tr>
                                                  <tr>
                                                    <td>Rental income</td>
                                                    <td data-updates="lease-ttl-1" id="lease-amt-1">$0.00</td>
                                                  </tr>
                                                </tbody>
                                                <tfoot>
                                                  <tr>
                                                    <td><span class="loc-staddress-1">location 1</span> qualifying expenses</td>
                                                    <td id="amt-ttl-1">$0.00</td>
                                                  </tr>
                                                  <tr>
                                                    <td><span class="loc-staddress-1">location 1</span> lockdown support amount</td>
                                                    <td id="amt-top-up-1">$0.00</td>
                                                  </tr>
                                                </tfoot>
                                             </table>
                                          </details>
                                       </footer>
                                    </fieldset>
                                    <p class="mrgn-bttm-sm">
                                       <button class="btn btn-default" type="button" id="addLoc"><span
                                          class="fas fa-plus-circle"></span> Add
                                       another location</button>
                                    </p>
                                 </fieldset>
                                 <p class="h3 mrgn-tp-lg brdr-tp"><span class="fas fa-building"></span> Save your location data for your records</p>
                                 <p>Review your location data and print or download a spreadsheet for your records.</p>
                                  <ul class="list-unstyled">
                                      <li class="mrgn-tp-md"><a href="#loc-calculation-table" aria-controls="loc-calculation-table"
                                        class="wb-lbx lbx-modal btn btn-primary" role="button" id="showLocTable">Review locations summary</a>
                                      </li>
                                      <!-- <li class="mrgn-tp-md">
                                        <button type="button" id="transfer-data" class="btn btn-primary">Calculate and send data to the
                                          form below (into Step 2b)</button>
                                        </li> -->
                                  </ul>
                              </div>
                           </div>
                           <section id="loc-calculation-table"
                              class="mfp-hide modal-dialog modal-content overlay-def wb-popup-full">
                              <header class="modal-header">
                                 <h2 class="modal-title">Claim amount calculations per location for claim period <span
                                    class="claim-period"></span></h2>
                              </header>
                              <div class="modal-body">
                                 <p class="mrgn-bttm-md">
                                    <button type="button" class="btn btn-default hidden-print toCSV"><span
                                       class="fas fa-download"></span> Download the
                                    following table as spreadsheet file (CSV)</button>
                                 </p>
                                 <div class="table-responsive">
                                    <table class="table table-bordered table-condensed small" id="dataset-filter"
                                       summary="Claim amount calculations per location for claim period">
                                       <thead>
                                          <tr>
                                            <th>Business location(s)</th>
                                            <th>Lockdown (days)</th>
                                            <th>Rent</th>
                                            <th>Property tax</th>
                                            <th>Property insurance</th>
                                            <th>Interest on commercial mortgages</th>
                                            <th>Rental income</th>
                                            <th>Qualifying expenses</th>
                                            <th>Lockdown support amount</th>
                                          </tr>
                                       </thead>

                                       <!-- Some kind of indication of which should be included in your application? -->

                                       <tbody>
                                          <tr id="loc1">
                                             <td>
                                              <span class="full-address-1">Location 1</span>
                                             </td>
                                              <td id="top-up-days-smry-1" data-updated-by="top-up-days-1">0</td>
                                              <td id="rent-smry-1" data-updated-by="rent-amt-1"></td>
                                              <td id="tax-smry-1" data-updated-by="tax-amt-1"></td>
                                              <td id="insurance-smry-1" data-updated-by="insurance-amt-1"></td>
                                              <td id="interest-smry-1" data-updated-by="interest-amt-1"></td>
                                              <td id="lease-smry-1" data-updated-by="lease-amt-1"></td>
                                              <td id="qre-smry-1" data-updated-by="amt-ttl-1"></td>
                                              <td id="top-up-smry-1" data-updated-by="amt-top-up-1"></td>
                                          </tr>
                                       </tbody>
                                       <tfoot>
                                          <tr>
                                             <td class="nowrap">Total locations: <span class="numLocs"></span></td>
                                             <td><span>-</span></td>
                                             <td><span class="rent-total">-</span></td>
                                             <td><span class="tax-total">-</span></td>
                                             <td><span class="insurance-total">-</span></td>
                                             <td><span class="interest-total">-</span></td>
                                             <td><span class="lease-total">-</span></td>
                                             <td><span class="qre-total">-</span></td>
                                             <td><span class="top-up-total"></span></td>
                                          </tr>
                                          <tr>
                                            <td colspan="9">Calculated basic CERS amount: <span class="base-subsidy-amount">$0.00</span> (based on your <span class="base-rate">0%</span> rate)</td>
                                          </tr>
                                       </tfoot>
                                    </table>
                                 </div>
                                 <ul class="list-inline">
                                    <li>
                                       <button onclick="window.print()" class="btn btn-success btn-lg hidden-print"><span
                                          class="glyphicon glyphicon-print"></span> Print this summary (or save to PDF)</button>
                                    </li>
                                    <li class="pull-right">
                                       <button title="Close overlay" class="btn btn-sm btn-default pull-right popup-modal-dismiss"
                                          type="button">Close<span class="wb-inv"> overlay</span></button>
                                    </li>
                                 </ul>
                              </div>
                              <div class="modal-footer hidden"> </div>
                           </section>
                        </fieldset>
                     </li>
                     <li>
                       <fieldset>
                          <legend><span class="wb-inv">Step 5: </span>Get results</legend>
                          <p>After completing the steps above, you can now calculate the results.</p>
                          <p>
                            <button id="calculate" class="btn btn-primary btn-lg" type="submit">Calculate your total rent subsidy</button>
                          </p>
                       </fieldset>
                     </li>
                  </ol>
               </form>
            </div>
            <div class="panel panel-primary hidden" id="results">
              <header class="panel-heading">
                 <h2 class="panel-title">Canada Emergency Rent Subsidy (CERS) amount to claim</h2>
              </header>
              <div class="panel-body">
                 <div id="cers-statement">
                    <p class="lead"><strong>Print and keep this record using the print preview button below</strong>.</p>
                    <p>The line amounts you will need to complete your application for <strong><span class="claim-period"></span></strong> of the CERS in your online CRA account:</p>
                    <ul class="lst-spcd">
                       <li><strong>Line 110:</strong>
                          Number of eligible properties: <strong>
                          <span class="numLocs h3">0</span>
                          </strong>
                       </li>
                       <li><strong>Line 120:</strong>
                          Total eligible rent paid: <strong>
                          <span class="rent-total h3">$0.00</span>
                          </strong>
                       </li>
                       <li><strong>Line 130:</strong>
                          Total eligible property taxes paid:
                          <span class="tax-total h3">$0.00</span>
                       </li>
                       <li><strong>Line 140:</strong>
                          Total eligible property insurance paid:
                          <span class="insurance-total h3">$0.00</span>
                       </li>
                       <li><strong>Line 150:</strong>
                          Total eligible interest paid on commercial mortgages entered into for the purpose of purchasing real property:
                          <span class="interest-total h3">$0.00</span>
                       </li>
                       <li><strong>Line 160:</strong>
                          Total qualifying rent expenses:<strong>
                          <span class="qre-total h3">$0.00</span>
                          </strong>
                       </li>
                       <li><strong>Line 200:</strong>
                          Revenue drop for the current period:<strong>
                          <span class="currentRevReduction h3">0.00%</span>
                          </strong>
                       </li>
                       <li><strong>Line 210:</strong>
                          Revenue drop for the previous period:<strong>
                          <span class="priorRevReduction h3">0.00%</span>
                          </strong>
                       </li>
                       <li><strong>Line 310:</strong> Subsidy top-up (lockdown support): <strong>
                          <span class="top-up-total h3">$0.00</span>
                          </strong>
                       </li>
                        <li id="smry-staddress-desc" class="hidden">You will need to include these location addresses in your application:
                          <ul>
                            <li class="hidden" id="smry-staddress-1"></li>
                            <li class="hidden" id="smry-staddress-2"></li>
                            <li class="hidden" id="smry-staddress-3"></li>
                          </ul>
                        </li>
                    </ul>
                 </div>
              </div>
              <table class="table" id="cers-statement-table">
                 <caption class="h5 mrgn-bttm-0">
                    Period <span class="claim-period-no"></span>: Summary of CERS calculation
                 </caption>
                 <tbody>
                    <tr>
                       <th scope="row" class="h6">Affiliated entity percentage</th>
                       <td class="text-right nowrap"><output class="affiliated-entity-percentage">N/A</output></td>
                    </tr>
                    <tr>
                       <th scope="row" class="h6">Maximum expenses that can be claimed for the base subsidy <small>(Line 170: Lesser of line 160 or $300,000 or $300,000 x Affiliated entity percentage)</small></th>
                       <td class="text-right nowrap"><output class="qualifying-rent-expenses">$0.00</output></td>
                    </tr>
                    <tr>
                       <th scope="row" class="h6">Rent subsidy rate</th>
                       <td class="text-right nowrap"><abbr title="multipled by" class="brdr-0">x</abbr><output class="mrgn-lft-sm base-rate">0.00%</output></td>
                    </tr>
                    <tr>
                       <th scope="row" class="h6">Basic CERS amount <small class="nowrap">(Line 300)</small></th>
                       <td class="text-right nowrap">=<output class="mrgn-lft-sm base-subsidy-amount">$0.00</output></td>
                    </tr>
                    <tr>
                       <th scope="row" class="h6">Subsidy top-up (lockdown support) amount <small class="nowrap">(Line 310)</small></th>
                       <td class="text-right nowrap">+<output class="top-up-total mrgn-lft-sm">$0.00</output></td>
                    </tr>
                    <tr class="success">
                       <th scope="row" class="h6">Total Canada Emergency Rent Subsidy <small class="nowrap">(Line 300 + Line 310)</small></th>
                       <td class="text-right nowrap"><output class="rent-subsidy-claim-total mrgn-lft-sm h3">$0.00</output></td>
                    </tr>
                 </tbody>
              </table>
              <div class="panel-body">
                 <p>You are now ready to <strong>print these amounts</strong> so you can enter them into your rent subsidy application. The data is not saved on this page. <strong>If you leave this page without printing you will need to enter your information again.</strong></p>
                 <p class="hidden-print"><a href="#pp-statement" class="wb-lbx btn btn-default btn-lg"
                    role="button"><span class="h3"><span class="glyphicon glyphicon-print"></span> Print preview (or save to PDF) <span class="wb-inv"> CERS
                    statement</span></span></a>
                 </p>
              </div>
           </div>
            <nav class="mrgn-bttm-lg mrgn-tp-lg">
               <h3 class="wb-inv">Document navigation</h3>
               <ul class="pager">
                  <li class="next"><a href="how-apply.html" rel="next">How to apply</a></li>
               </ul>
            </nav>
         </section>

         <section id="pp-statement" class="mfp-hide modal-dialog modal-content overlay-def experimental">
            <header class="modal-header">
               <h2 class="modal-title">Print preview for CERS statement</h2>
            </header>
            <div class="modal-body">
               <div data-ajax-replace=" #cers-statement"></div>
               <div data-ajax-replace=" #cers-statement-table"></div>
               <ul class="list-inline">
                  <li>
                     <button onclick="window.print()" class="btn btn-success btn-lg"><span
                        class="glyphicon glyphicon-print"></span> Print this statement</button>
                  </li>
                  <li class="pull-right">
                     <button title="Close overlay" class="btn btn-sm btn-default pull-right popup-modal-dismiss"
                        type="button">Close<span class="wb-inv"> overlay</span></button>
                  </li>
               </ul>
            </div>
            <div class="modal-footer hidden"> </div>
         </section>
         <!--
         <section id="pay-claim" class="mfp-hide modal-dialog modal-content overlay-def">
            <header class="modal-header">
               <h2 class="modal-title">Claim period pay per week<span class="loc-lv hidden"> and active locations or locations
                  on leave with pay</span>
               </h2>
            </header>
            <div class="modal-body">
               <h3>Claim period pay per week</h3>
               <div data-ajax-replace="who-locations.html #week-cntnt">
                  <p><a href="who-locations.html#week">Claim period pay per week</a></p>
               </div>
               <div class="loc-lv hidden">
                  <h3>Active locations and locations on leave with pay</h3>
                  <div data-ajax-replace="who-locations.html #leave-cntnt">
                     <p><a href="who-locations.html#leave">Active locations and locations on leave with pay</a></p>
                  </div>
               </div>
            </div>
         </section>
       -->
         <section id="eligible-rev" class="mfp-hide modal-dialog modal-content overlay-def">
            <header class="modal-header">
               <h2 class="modal-title">Eligible revenue</h2>
            </header>
            <div class="modal-body">
               <p>These months are needed to calculate your revenue drops for the current period, prior period, and top-up
                  period, using your chosen baseline.
               </p>
               <p>Read more about <a href="who-apply.html" target="_blank">eligible <span
                  class="nowrap">revenue<span class="far fa-window-restore mrgn-lft-sm"></span></span><span class="wb-inv">
                  (opens in new window)</span></a>
               </p>
            </div>
         </section>

         <!--This is not relevant for the estimated range output--<p>[Save or copy the result of your calculation to enter when you apply for the benefit.]</p>-->

         </section>
         <div id="def-preFooter"></div>
         <!-- Write closure tloclate -->
         <script type="text/javascript">
            var defPreFooter = document.getElementById("def-preFooter");
            defPreFooter.outerHTML = wet.builder.preFooter({
              dateModified: "2020-08-02",
              showPostContent: true,
              showFeedback: true,
              showShare: true
            });
         </script>
      </main>
      <div id="def-footer"></div>
      <!-- Write closure tloclate -->
      <script type="text/javascript">
         var defFooter = document.getElementById("def-footer");
         defFooter.outerHTML = wet.builder.footer({
           showFooter: true,
           showFeatures: true
         });
      </script>
      <!-- Write closure tloclate -->
      <script type="text/javascript">
         document.write(wet.builder.refFooter({
         }));
      </script>
      <script src="https://test.canada.ca/covid-19-guidance/proto/js/alpha-banner.js"></script>
      <script>
        /**
         * LocationFormGenerator class
         * used to help creating new location forms
         */
        var LocationFormGenerator = (function () {
          /**
           * Constructor
           */
          function LocationFormGenerator() {
            //the payschedule chosen by the user
            // this.paySchedule = paySchedule;
            //variables to avoid magic numbers & strings
            this.prefix = "";
            this.numberOfLocations = 1;
            this.templateId = "loc-1";
            this.classUpdates = [ //any classes that get updated
              "loc-staddress-",
              "top-up-rate-",
              "month-one-",
              "month-two-",
              "cers-period-",
              "rent-expense-",
              "rent-location-",
              "own-location-",
              "date-tax-start-",
              "date-insurance-start-",
              "date-interest-start-",
              "date-lease-start-",
              "date-tax-end-",
              "date-insurance-end-",
              "date-interest-end-",
              "date-lease-end-",
              "lockdown-details-"
            ];
            this.idUpdates = [ //any ids or aria-describedby that get updated
              "lock-down-ineligible-",
              "lock-down-eligible-",
              "top-up-days-",
              "choose-own-or-rent-message-",
              "lock-down-period-",
              "rent-amt-",
              "tax-amt-",
              "insurance-amt-",
              "interest-amt-",
              "lease-amt-",
              "amt-ttl-",
              "amt-top-up-",
              "rent-one-date-",
              "lease-one-date-",
              "rent-two-date-",
              "lease-two-date-",
              "rent-cers-period-date-",
              "lease-cers-period-date-",
              "tax-date-",
              "insurance-date-",
              "interest-date-",
              "lease-date-",
              "tax-date-error-",
              "insurance-date-error-",
              "interest-date-error-",
              "lease-date-error-",
              "loc-address-"
            ];
            this.locationIndexRegex = /-1\b/g;

            //CEWS legacy for reference
            // this.armsLengthId = "arms-";
            // this.baselineId = "baseline-"
            // this.locationNumberClass = "locationNumber";
            // this.removeablePanelClass = "extra-loc-pnl";
            // this.currencyPlaceholderValue = "$0";
            // this.weeklySummaryRentClass = "loc-rent-1";
            // this.weeklySummaryTaxClass = "loc-tax-1";
            // this.weeklySummaryInsuranceClass = "loc-insurance-1";
            // this.weeklySummaryInterestClass = "loc-interest-1";
            // this.weeklySummaryClass = "loc-expenses-";
          }

          /**
           * generateNewLocationForm
           *
           * function called to run the routine to generate the new form
           *
           * @param {Int} numLocs the number of location panels currently on the
           * page
           *
           * @return {DOMDocumentFragment} the cloned tloclate with ID's and other
           * attributes updated for use in as a new location form
           */
          LocationFormGenerator.prototype.generateNewLocationForm = function (numLocs) {
            //update number of location frames
            this.numberOfLocations = numLocs;
            //generate another location form
            var newForm = this.generateNewForm();
            return newForm;
          }

          /**
           * generateNewForm
           *

           * clone the tloclate DOM element and update the required attributes for
           * a new location wage form
           *
           * @calls LocationFormGenerator::updateArmsLengthElementId()
           * @calls LocationFormGenerator::updateBaselineWageElementId() to update
           * the baseline wage element
           * @calls LocationFormGenerator::setUpdatesAndUpdatedByData() to update
           * the data-updates and data-update-by attributes
           * @calls LocationFormGenerator::updateInputs() to update the input fields
           * @calls LocationFormGenerator::updateTableIds() to update the summary
           * table cells
           * @calls LocationFormGenerator::openAccordion() to open all accordion
           * elements
           *
           * @return {DOMDocumentFragment} the update DOM fragment to be used as
           * the new location wage form
           */
          LocationFormGenerator.prototype.generateNewForm = function () {
            var frag = $("#" + this.templateId).clone();
            //update the frame id
            $(frag).attr("id", $(frag).attr("id").replace("-1", "-" + this.numberOfLocations));
            //add class that will be used to identify panels to remove when the selected pay schedule is changed
            $(frag).addClass(this.removeablePanelClass);
            //update the location number text
            var numLocs = this.numberOfLocations;
            $(frag).find("." + this.locationNumberClass).each(function (e, element) {
              $(element).text(numLocs);
            });
            //add the aria-live=polite attr for screen readers
            $(frag).attr("aria-live", "polite");
            var rmBtn = $(frag).find(".rm-loc");
            $(rmBtn).removeClass("hidden");
            //detect if browser uses chromium
            var isChromium = window.chrome;
            //update the DOM fragment
            this.updateLocationNames(frag);
            this.updateLocNumbers(frag);
            this.updateSelectDropdown(frag);
            this.updateClass(frag);
            this.updateIds(frag);
            if (!isChromium) {
              this.clearInitializedExpandHide(frag, "lockdown-details", "To qualify for lockdown support");
              this.clearInitializedExpandHide(frag, "location-details", "Expense summary for <span class='loc-staddress-" + numLocs + "'>location 1</span>");
              this.clearInitializedDatePickers(frag);
            }
            this.setUpdatesAndUpdatedByData(frag);
            this.visualDefaults(frag);
            return frag;
          }

          /**
           * updateAddressFieldIds
           *
           * update the address fields' elements
           *
           * @param {DOMDocumentFragment} frag the cloned templateId
           */
          LocationFormGenerator.prototype.updateLocationNames = function (frag) {
            $(frag).find('.locationNumber').text(this.numberOfLocations);
          }

          /**
           * updateLocNumbers
           *
           * update the location numbers for input elements
           *
           * @param {DOMDocumentFragment} frag the cloned templateId
           */
           LocationFormGenerator.prototype.updateLocNumbers = function (frag) {
            var inputs = $(frag).find("input[id$='-1']");
            var numLocs = this.numberOfLocations;
            var indexRegex = this.locationIndexRegex;
            $(inputs).each(function (i, element) {
              if ($(element).is(":checkbox")) {
                $(element).prop("checked", false);
              } else if ($(element).is(":radio")) { //adding radio button uncheck
                //uncheck the previously selected option
                $(element).prop("checked", false);
                $(element).attr("name",
                  $(element).attr("name").replace(indexRegex, "-" + numLocs)
                ); //update radio buttons with new name
              } else if ($(element).attr("name") == "lockdown-start-1" || $(element).attr("name") == "lockdown-end-1") { //date picker
                //update the name of the datepickers
                $(element).attr("name",
                  $(element).attr("name").replace(indexRegex, "-" + numLocs)
                );
              } else if ($(element).is("select")) { //if select dropdown, then reset to default option
                $(element).first("option").attr("selected", true);
              } else if ($(element).val().length > 0) {
                $(element).val("");
              }
              //need to get the label for each of these elements and update the 'for' attr
              var label = $(frag).find("label[for='" + $(element).attr("id") + "']");
              $(element).attr(
                "id",
                $(element).attr("id").replace(indexRegex, "-" + numLocs)
              );
              $(label).attr(
                "for",
                $(label).attr("for").replace(indexRegex, "-" + numLocs)
              );
            });
          }

          /**
           * updateSelectDropdown
           *
           * update the select elements
           *
           * @param {DOMDocumentFragment} frag the cloned templateId
          */
          LocationFormGenerator.prototype.updateSelectDropdown = function (frag) {
            var selects = $(frag).find("select[id$='-1']");
            var numLocs = this.numberOfLocations;
            var indexRegex = this.locationIndexRegex;
            $(selects).each(function (i, element) {
              //update id and label for
              var label = $(frag).find("label[for='" + $(element).attr("id") + "']");
              $(element).attr(
                "id",
                $(element).attr("id").replace(indexRegex, "-" + numLocs)
              );
              $(label).attr(
                "for",
                $(label).attr("for").replace(indexRegex, "-" + numLocs)
              );
            });
          }

          /**
           * updateClass
           *
           * update the class elements based on the parametrs
           *
           * @param {DOMDocumentFragment} frag the cloned templateId
           */
          LocationFormGenerator.prototype.updateClass = function (frag) {
            for (let i = 0; i < this.classUpdates.length; ++i) {
              var classUpdateElement = $(frag).find(
                "." + this.classUpdates[i] + "1"
              );
              //loop through the different elements with the class
              for (let q = 0; q < classUpdateElement.length; ++q) {
                $(classUpdateElement[q]).attr("class", $(classUpdateElement[q]).attr("class").replace(this.locationIndexRegex, "-" + this.numberOfLocations));
              }
            }
          }

          /**
           * updateIds
           *
           * update the id based on the parametrs
           *
           * @param {DOMDocumentFragment} frag the cloned templateId
          */
          LocationFormGenerator.prototype.updateIds = function (frag) {
            for (let i = 0; i < this.idUpdates.length; ++i) {
              var idUpdateElement = $(frag).find(
                "#" + this.idUpdates[i] + "1"
              );
              $(idUpdateElement).attr("id", $(idUpdateElement).attr("id").replace(this.locationIndexRegex, "-" + this.numberOfLocations));
              // if there is also an associated ariadescribedby, update that too
              var ariaUpdateElement = $(frag).find(
                "[aria-describedby='" + this.idUpdates[i] + "1']"
              );
              if (ariaUpdateElement.length > 0) {
                $(ariaUpdateElement).attr("aria-describedby", $(ariaUpdateElement).attr("aria-describedby").replace(this.locationIndexRegex, "-" + this.numberOfLocations));
              }
            }
          }

          /**
           * clearInitializedExpandHide
           *
           * replace an expand hide summary element with an uninitialized version for WET
           *
           * @param {DOMDocumentFragment} frag the cloned templateId
          */
          LocationFormGenerator.prototype.clearInitializedExpandHide = function (frag, summaryClass, summaryText) {
            //create new summary element for the top up expand hide
            var newExHide = document.createElement("summary");
            $(newExHide).attr("class", summaryClass);
            $(newExHide).html(summaryText);
            $(frag).find("."+summaryClass).replaceWith(newExHide);
          }


          /**
           * clearInitializedDatePickers
           *
           * replace the date picker elements with a uninitialized versions for WET
           *
           * @param {DOMDocumentFragment} frag the cloned templateId
          */
          LocationFormGenerator.prototype.clearInitializedDatePickers = function (frag) {
            //create new date input for the new location and clear the location 1 initialized html, if applicable (safari, IE)
            var numLocs = this.numberOfLocations;

            var datepickerStart = document.createElement("input");
            $(datepickerStart).attr("class", "form control lockdown-start-date");
            $(datepickerStart).attr("type", "date");
            $(datepickerStart).attr("name", "lockdown-start-"+numLocs);
            $(datepickerStart).attr("id", "lockdown-start-"+numLocs);
            $(frag).find(".lockdown-start-datepicker-init").replaceWith(datepickerStart);

            var datepickerEnd = document.createElement("input");
            $(datepickerEnd).attr("class", "form control lockdown-end-date");
            $(datepickerEnd).attr("type", "date");
            $(datepickerEnd).attr("name", "lockdown-end-"+numLocs);
            $(datepickerEnd).attr("id", "lockdown-end-"+numLocs);
            $(frag).find(".lockdown-end-datepicker-init").replaceWith(datepickerEnd);
          }

          /**
           * setUpdatesAndUpdatedByData
           *
           * increment the date-updates and data-updated-by value so the
           * appropriate summary table is updated
           *
           * @param {DOMDocumentFragment} frag the cloned tloclate
           */
          LocationFormGenerator.prototype.setUpdatesAndUpdatedByData = function (frag) {
            var updateElements = $(frag).find("*[data-updates$='-1']");
            var updatedByElements = $(frag).find("*[data-updated-by$='-1']");
            var numLocs = this.numberOfLocations;
            var indexRegex = this.locationIndexRegex;
            $(updateElements).each(function (i, element) {
              var newval = $(element).data("updates").replace(indexRegex, "-" + numLocs);
              $(element).attr("data-updates", newval);
            });
            $(updatedByElements).each(function (i, element) {
              var newval = $(element).data("updated-by").replace(indexRegex, "-" + numLocs)
              $(element).attr("data-updated-by", newval);
            });
          }

          /**
           * visualDefaults
           *
           * make sure the new location form displays the correct sections (hide/shows, open accordion, etc)
           *
           * @param {DOMDocumentFragment} frag the cloned tloclate
           */
          LocationFormGenerator.prototype.visualDefaults = function (frag) {
            var numLocs = this.numberOfLocations;
            //hide the lockdown fields
            $(frag).find('#lock-down-period-' + numLocs).addClass("hidden");
            $(frag).find('#lock-down-ineligible-' + numLocs).removeClass("hidden");
            $(frag).find('#lock-down-eligible-' + numLocs).addClass("hidden");
            $(frag).find('.rent-location-' + numLocs).addClass("hidden");
            $(frag).find('.own-location-' + numLocs).addClass("hidden");
            $(frag).find('#choose-own-or-rent-message-' + numLocs).removeClass("hidden");
            //open the accordion for the summary details
            var accordion = $(frag).find(".smry-accordion-details").each(function (i, element) {
              $(element).attr("open", "open");
            });
            //Update the Location name text in summary
            $(frag).find(".loc-staddress-" + numLocs).text("Location " + numLocs);
            //Clear the summary values
            $(frag).find('#rent-amt-' + numLocs).text("$0.00");
            $(frag).find('#tax-amt-' + numLocs).text("$0.00");
            $(frag).find('#insurance-amt-' + numLocs).text("$0.00");
            $(frag).find('#interest-amt-' + numLocs).text("$0.00");
            $(frag).find('#lease-amt-' + numLocs).text("$0.00");
            $(frag).find('#amt-ttl-' + numLocs).text("$0.00");
            $(frag).find('#amt-top-up-' + numLocs).text("$0.00");
            //Update the date pickers to the date range of the period
            // //in IE and Safari, also need to update the datepicker generated ID
            // $(frag).find('#lockdown-start-1-picker-toggle').attr("id", '#lockdown-start-' + numLocs + '-picker-toggle');
            // $(frag).find('#lockdown-end-1-picker-toggle').attr("id", '#lockdown-end-' + numLocs + '-picker-toggle');
            //Update all the owned location inputs to have the default 'select a period' message
            $(frag).find('#tax-date-' + numLocs).addClass("hidden");
            $(frag).find('#tax-date-error-' + numLocs).removeClass("hidden");
            $(frag).find('#insurance-date-' + numLocs).addClass("hidden");
            $(frag).find('#insurance-date-error-' + numLocs).removeClass("hidden");
            $(frag).find('#interest-date-' + numLocs).addClass("hidden");
            $(frag).find('#interest-date-error-' + numLocs).removeClass("hidden");
            $(frag).find('#lease-date-' + numLocs).addClass("hidden");
            $(frag).find('#lease-date-error-' + numLocs).removeClass("hidden");
          }

          return LocationFormGenerator;
        })();

      </script>
      <script>
        (function ($, window, wb) {
          "use strict";
          /*
          * Variable and function definitions.
          * These are global to the plugin - meaning that they will be initialized once per page,
          * not once per instance of plugin on the page. So, this is a good place to define
          * variables that are common to all instances of the plugin on a page.
          */
          // function that should be moved as a helper class or something
          const toMoney = new Intl.NumberFormat(wb.lang + "-CA", {
            style: "currency",
            currency: "CAD",
            minimumFractionDigits: 2
          });
          var locationFormGenerator = new LocationFormGenerator();
          var componentName = "wb-calc",
            selector = "." + componentName,
            initEvent = "wb-init" + selector,
            $document = wb.doc,
            defaults = {},
            sep = {
              iso: {
                en: "--",
                fr: "--"
              },
              claim: {
                en: " to ",
                fr: " au "
              }
            },
            /**
             * @method init
             * @param {jQuery Event} event Event that triggered the function call
             */
            init = function (event) {
              // Start initialization
              // returns DOM object = proceed with init
              // returns undefined = do not proceed with init (e.g., already initialized)

              var elm = wb.init(event, componentName, selector),
                $elm,
                settings;

              if (elm) {
                $elm = $(elm);
                // ... Do the plugin initialisation
                // Get the plugin JSON configuration set on attribute data-wb-helloworld
                settings = $.extend(
                  true,
                  {},
                  defaults,
                  window[componentName],
                  wb.getData($elm, componentName)
                );

                // Call my custom event
                $elm.trigger("change", settings);
                // Identify that initialization has completed
                wb.ready($elm, componentName);
              }
            };

          // Plugin event handlers
          $document.on("change", "input", function (event) {
            var elm = event.currentTarget,
              $elm = $(elm),
              $elmId = $elm.attr("id"),
              data = wb.getData($("output[for='" + $elmId + "']"), componentName),
              value = $elm.val().replace(/\,\s/g, ''), // Needs to be replaced by data.expr evaluation
              total = 0;

            if (data.expr) {
              //protect against NaN values
              if (value == "") {
                value = 0;
              }
              if (data.format === "currency") {
                $("output[for='" + $elmId + "']").html(toMoney.format(value * 1));
              } else {
                $("output[for='" + $elmId + "']").html(value * 1);
              };
            }

            total = ($("#p2c-CERS").val() * 1) + ($("#p3-ei").val() * 1) + ($("#p3-cpp").val() * 1) - ($("#p4-tws").val() * 1) - ($("#p4-wsb").val() * 1);
            if (total < 0) {
              $("[for='p2c-CERS p3-ei p3-cpp p4-tws p4-wsb']").html(toMoney.format(0));
            } else {
              $("[for='p2c-CERS p3-ei p3-cpp p4-tws p4-wsb']").html(toMoney.format(total));
            };
          });

          $document.on("change", selector, function (event, data) {
            var elm = event.currentTarget,
              $elm = $(elm),
              $input = $("#" + $elm.attr("for")),
              value = $input.val();

            if (data && data.format === "currency") {
              $elm.html(toMoney.format(value * 1));
            } else {
              $elm.html(value * 1);
            };
            $("[for='p2c-ee p2c-pyrl p2c-CERS p3-ei p3-cpp p4-tws p4-wsb']").html(toMoney.format(0));
          });

          //when the claim period dropdown is changed
          $document.on("change", "#claim-period", function (event) {
            var rangeISO = $(this).find('option:selected').val(),
              startDateISO = rangeISO.substring(0, rangeISO.indexOf(sep.iso[wb.lang])),
              endDateISO = rangeISO.substring(rangeISO.indexOf(sep.iso[wb.lang]) + sep.iso[wb.lang].length, rangeISO.length),
              rangeClaim = $(this).find("option:selected").text(),
              rangeClaimNo = rangeClaim.substring(7, 8),
              startDateClaim = rangeClaim.substring(0, rangeClaim.indexOf(sep.claim[wb.lang])),
              endDateClaim = rangeClaim.substring(rangeClaim.indexOf(sep.claim[wb.lang]) + sep.claim[wb.lang].length, rangeClaim.length);

            var startDateParts = startDateISO.split("-");
            var endDateParts = endDateISO.split("-");
            var claimMonth = getClaimMonth(rangeISO);
            var claimPeriod = parseInt($("#claim-period option:selected").data("claim-period"));
            var claimMonths = getMonthNamesPlusYear(endDateParts[1], claimPeriod); //send the endDate month number

            //Get the priorReference period based on the claimMonth
            var monthsArray = getClaimMonths(claimMonth, claimPeriod);
            var priorReferenceMonth = monthsArray[1].split("-");
            var priorReferenceMonth = getMonthNamesPlusYear(priorReferenceMonth[1], claimPeriod);

            //Populate based on step 1 period selection
            if (!$("#claim-period option:selected:eq(0)")) {
              $('.claim-period').html("<time datetime=\"" + startDateISO + "\">" + startDateClaim + "</time>" + sep.claim[wb.lang] + "<time datetime=\"" + endDateISO + "\">" + endDateClaim + "</time>"); //Populate the step 1 summary box
            } else {
              $('.claim-period').html($("#claim-period option:selected").text());
              $(".claim-period-no").text(claimPeriod);
              $('.claim-month-one').text(claimMonths[0]);
              $('.claim-month-two').text(claimMonths[1]);
              $('.prior-reference-month').text(priorReferenceMonth[1]); //this should give the month/year of the prior reference period

              //date in format 2020-xx-xx
              //last day of month
              var lastDayMonthOne = new Date(startDateParts[0], startDateParts[1] + 1, 0).getDate();
              var lastDayMonthTwo = new Date(endDateParts[0], endDateParts[1] + 1, 0).getDate();
              $('.date-month-one-start').text(startDateISO.substring(0, 8) + '01');
              $('.date-month-one-end').text(startDateISO.substring(0, 8) + lastDayMonthOne);
              $('.date-month-two-start').text(endDateISO.substring(0, 8) + '01');
              $('.date-month-two-end').text(endDateISO.substring(0, 8) + lastDayMonthTwo);
              $('.date-cers-period-start').text(startDateISO);
              $('.date-cers-period-end').text(endDateISO);
            }

            //show/hide elements based on chosen claim period
            $("#select-a-claim-period-reminder").addClass("hidden");
            $("#rate-reduction").removeClass("hidden");

            switch (claimPeriod) {
              case 3:
                $("#2020-12-yes").closest("div.form-group").removeClass("hidden");
                $("#2020-11-yes").closest("div.form-group").removeClass("hidden");
                $("#2020-10-yes").closest("div.form-group").addClass("hidden");
                $("#2020-09-yes").closest("div.form-group").addClass("hidden");
                $("#2020-12-no").closest("div.form-group").removeClass("hidden");
                $("#2019-12-no").closest("div.form-group").removeClass("hidden");
                $("#2020-11-no").closest("div.form-group").removeClass("hidden");
                $("#2019-11-no").closest("div.form-group").removeClass("hidden");
                $("#2020-10-no").closest("div.form-group").addClass("hidden");
                $("#2019-10-no").closest("div.form-group").addClass("hidden");
                $("#2020-09-no").closest("div.form-group").addClass("hidden");
                $("#2019-09-no").closest("div.form-group").addClass("hidden");
                break;
              case 2:
                $("#2020-12-yes").closest("div.form-group").addClass("hidden");
                $("#2020-11-yes").closest("div.form-group").removeClass("hidden");
                $("#2020-10-yes").closest("div.form-group").removeClass("hidden");
                $("#2020-09-yes").closest("div.form-group").addClass("hidden");
                $("#2020-12-no").closest("div.form-group").addClass("hidden");
                $("#2019-12-no").closest("div.form-group").addClass("hidden");
                $("#2020-11-no").closest("div.form-group").removeClass("hidden");
                $("#2019-11-no").closest("div.form-group").removeClass("hidden");
                $("#2020-10-no").closest("div.form-group").removeClass("hidden");
                $("#2019-10-no").closest("div.form-group").removeClass("hidden");
                $("#2020-09-no").closest("div.form-group").addClass("hidden");
                $("#2019-09-no").closest("div.form-group").addClass("hidden");
                break;
              case 1:
                $("#2020-12-yes").closest("div.form-group").addClass("hidden");
                $("#2020-11-yes").closest("div.form-group").addClass("hidden");
                $("#2020-10-yes").closest("div.form-group").removeClass("hidden");
                $("#2020-09-yes").closest("div.form-group").removeClass("hidden");
                $("#2020-12-no").closest("div.form-group").addClass("hidden");
                $("#2019-12-no").closest("div.form-group").addClass("hidden");
                $("#2020-11-no").closest("div.form-group").addClass("hidden");
                $("#2019-11-no").closest("div.form-group").addClass("hidden");
                $("#2020-10-no").closest("div.form-group").removeClass("hidden");
                $("#2019-10-no").closest("div.form-group").removeClass("hidden");
                $("#2020-09-no").closest("div.form-group").removeClass("hidden");
                $("#2019-09-no").closest("div.form-group").removeClass("hidden");
                break;
              default:
            }
            //recalculate the summary based on the values that are already there
            if ($("#2020-" + claimMonth + "-no").is(":visible")) {
              calculateRevenueDrop(false);
            } else if ($("#2020-" + claimMonth + "-yes").is(":visible")) {
              calculateRevenueDrop(true);
            } else {
              NoCERSRate();
            }

            //Set top up lock down period date pickers with the defaults for that period and allowed range
            $('.lockdown-start-date').attr({
              "min": startDateISO,
              "max": endDateISO,
              "value": startDateISO
            });
            $('.lockdown-start-date').val(startDateISO);
            $('.lockdown-end-date').attr({
              "min": startDateISO,
              "max": endDateISO,
              "value": endDateISO
            });
            $('.lockdown-end-date').val(endDateISO);
            //recalculate top up for each location
            $(".lock-down-dates").each(function (i, element) {
              var parts = $(element).prop("id").split("-");
              var locationNumber = parts[parts.length - 1];
              topUpRateCalculation(locationNumber);
              recalculateLocationAmounts(locationNumber);
              //update the date ranges for input fields in owned location panels
              updateDateRangeInputs(locationNumber, "tax");
              updateDateRangeInputs(locationNumber, "insurance");
              updateDateRangeInputs(locationNumber, "interest");
              updateDateRangeInputs(locationNumber, "lease");
            });
          });

          //*****
          // when the submit button is clicked
          //*****


          $document.on("click", "#calculate", function (event) {
            event.preventDefault();
            //remove the required attribute in all hidden elements
            $("[required]:hidden").each(function (i, element) {
              $(element).removeAttr("required");
            });
            var count = 0,
              $elms = $(".wb-frmvld select[required], .wb-frmvld input[required]"),
              $emptyElms = [];
            //find all required fields that were left empty
            for (let i = 0; i < $($elms).length; i++) {
              var $elm = $($elms).eq(i);
              if ($elm.val() == "") {
                $emptyElms.push($elm);
                count++;
              }
            }
            //if WET4 already has errors, scroll to those
            if ($("#errors-default")[0]) {
              $('html, body').animate({ scrollTop: $("#errors-default").offset().top }, 'slow');
              //scroll to the FIRST element that failed custom validation
            } else if ($emptyElms[0]) {
              $('html, body').animate({ scrollTop: $($emptyElms[0]).offset().top }, 'slow');
              console.debug($emptyElms);
              //validation passed, show the results
            } else {
              calculateTotals();
              $("#results").removeClass("hidden");
            }
          });


          /**
           * update the location wage summary
           */
          $document.on("blur", "*[data-updates]", function (event) {
            var target = event.target;
            var parts = target.id.split("-");
            var locationNumber = parts[parts.length - 1];
            recalculateLocationAmounts(locationNumber);
          });

          /**
          * trigger the recalculation of all summary amounts for the location
          */
          $("input[id^=date-chooser-]").on("change", recalculateLocationAmounts);
          function recalculateLocationAmounts(locationNumber) {
            var calculatedExpense = [];
            var claimPeriod = $("#claim-period option:selected").data("claim-period");

            //get the number of days in each month that overlap the claim period
            var monthDays = getClaimMonth($("#claim-period").val(), 1);
            var monthMaxDays = getClaimMonth($("#claim-period").val(), 2);

            if ($('#rent-one-' + locationNumber).is(":visible")) {
              //get values for month 1 and month 2
              var unformattedValueOne = [
                $('#rent-one-' + locationNumber).val().replace("$", ""),
                "0", //0s to make sure that the amounts they're not eligible with their selections are recalculated to 0
                "0",
                "0",
                $('#lease-one-' + locationNumber).val().replace("$", "")
              ]
              var unformattedValueTwo = [
                $('#rent-two-' + locationNumber).val().replace("$", ""),
                "0",
                "0",
                "0",
                $('#lease-two-' + locationNumber).val().replace("$", "")
              ]
              //subdivide the amounts by the days in the period and add them for the total expense line
              for (let i = 0; i < unformattedValueOne.length; ++i) {
                calculatedExpense.push((zeroIfEmpty(unformattedValueOne[i]) * monthDays[0] / monthMaxDays[0]) +
                              (zeroIfEmpty(unformattedValueTwo[i]) * monthDays[1] / monthMaxDays[1]));
              }
            } else if ($('#rent-cers-period-' + locationNumber).is(":visible")) { //value for 28 day period
              var unformattedValueOne = [
                $('#rent-cers-period-' + locationNumber).val().replace("$", ""),
                "0",
                "0",
                "0",
                $('#lease-cers-period-' + locationNumber).val().replace("$", "")
              ]
              for (let i = 0; i < unformattedValueOne.length; ++i) {
                calculatedExpense.push(zeroIfEmpty(unformattedValueOne[i]));
              }
            } else if ($('#tax-own-' + locationNumber).is(":visible")) { //value for owned locations
              //owned property
              var unformattedValueOne = [
                "0",
                $('#tax-own-' + locationNumber).val().replace("$", ""),
                $('#insurance-own-' + locationNumber).val().replace("$", ""),
                $('#interest-own-' + locationNumber).val().replace("$", ""),
                $('#lease-own-' + locationNumber).val().replace("$", "")
              ]
              //Determine the period option
              var periodOption = [
                "NA",
                $('#date-chooser-tax-' + locationNumber + ' option:selected').data("calc-method"),
                $('#date-chooser-insurance-' + locationNumber + ' option:selected').data("calc-method"),
                $('#date-chooser-interest-' + locationNumber + ' option:selected').data("calc-method"),
                $('#date-chooser-lease-' + locationNumber + ' option:selected').data("calc-method")
              ]
              for (let i = 0; i < unformattedValueOne.length; ++i) {
                if (unformattedValueOne[i] == "0" || unformattedValueOne[i] == "" || unformattedValueOne[i] === null) {
                    calculatedExpense.push(0);
                } else if (periodOption[i] == 'none') {
                  //display error message
                  switch (i) {
                    case 1:
                      $('#tax-date-error-' + locationNumber).removeClass("hidden");
                      $('#tax-date-' + locationNumber).addClass("hidden");
                      break;
                    case 2:
                      $('#insurance-date-error-' + locationNumber).removeClass("hidden");
                      $('#insurance-date-' + locationNumber).addClass("hidden");
                      break;
                    case 3:
                      $('#interest-date-error-' + locationNumber).removeClass("hidden");
                      $('#interest-date-' + locationNumber).addClass("hidden");
                      break;
                    case 4:
                      $('#lease-date-error-' + locationNumber).removeClass("hidden");
                      $('#lease-date-' + locationNumber).addClass("hidden");
                      break;
                  }
                } else {
                  if (unformattedValueOne[i] == "0") {
                    calculatedExpense.push(0);
                  } else if (periodOption[i] == 'year') {
                    calculatedExpense.push(zeroIfEmpty(unformattedValueOne[i]) / 365 * 28);
                  } else if (periodOption[i] == 'period' ) {
                    calculatedExpense.push(zeroIfEmpty(unformattedValueOne[i]));
                  } else if (periodOption[i] == 'month' ) {
                    calculatedExpense.push((zeroIfEmpty(unformattedValueOne[i]) * monthDays[0] / monthMaxDays[0]) +
                                  (zeroIfEmpty(unformattedValueOne[i]) * monthDays[1] / monthMaxDays[1]));
                  }
                  switch (i) {
                    case 1:
                      $('#tax-date-error-' + locationNumber).addClass("hidden");
                      $('#tax-date-' + locationNumber).removeClass("hidden");
                      break;
                    case 2:
                      $('#insurance-date-error-' + locationNumber).addClass("hidden");
                      $('#insurance-date-' + locationNumber).removeClass("hidden");
                      break;
                    case 3:
                      $('#interest-date-error-' + locationNumber).addClass("hidden");
                      $('#interest-date-' + locationNumber).removeClass("hidden");
                      break;
                    case 4:
                      $('#lease-date-error-' + locationNumber).addClass("hidden");
                      $('#lease-date-' + locationNumber).removeClass("hidden");
                      break;
                  }
                }
              }
            } else { //if they haven't specified their calculation methods or something's buggy, totals should be 0
              var calculatedExpense = [0, 0, 0, 0, 0];
            }
            var summaryLines = ["rent-amt-" + locationNumber, "tax-amt-" + locationNumber, "insurance-amt-" + locationNumber, "interest-amt-" + locationNumber, "lease-amt-" + locationNumber];
            var formattedVal = 0;
            var updatedByElements = [];
            for (let i = 0; i < calculatedExpense.length; ++i) {
              formattedVal = toMoney.format(calculatedExpense[i]);
              $('#' + summaryLines[i]).text(formattedVal);
              updatedByElements = $('*[data-updated-by="' + summaryLines[i] + '"]'); //also update the relevant summary table lines
              $(updatedByElements).each(function (i, element) {
                $(element).text(formattedVal);
              });
            }
            //calculate and update the total
            var qualifyingExpenses = calculatedExpense[0] + calculatedExpense[1] + calculatedExpense[2] + calculatedExpense[3];
            qualifyingExpenses = Math.min(75000, qualifyingExpenses);
            qualifyingExpenses = qualifyingExpenses - calculatedExpense[4];
            qualifyingExpenses = Math.max(0, qualifyingExpenses); //values don't go negative for a location
            formattedVal = toMoney.format(qualifyingExpenses);
            $('#amt-ttl-' + locationNumber).text(formattedVal);
            updatedByElements = $('*[data-updated-by="amt-ttl-' + locationNumber + '"]'); //also update the relevant summary table lines
            $(updatedByElements).each(function (i, element) {
              $(element).text(formattedVal);
            });
            if ($('#lock-down-eligible-' + locationNumber).is(':visible')) {
              var topUpAmount = (qualifyingExpenses * topUpRate) / 100;
            } else {
              var topUpAmount = 0;
            }
            formattedVal = toMoney.format(topUpAmount);
            $('#amt-top-up-' + locationNumber).text(formattedVal);
            updatedByElements = $('*[data-updated-by="amt-top-up-' + locationNumber + '"]'); //also update the relevant summary table lines
            $(updatedByElements).each(function (i, element) {
              $(element).text(formattedVal);
            });
          }

          //Update location names on street address input
          $(document).on("blur", "input[id^='loc-staddress-']", function(event) {
            var className = $(event.target).prop("id");
            var locNumber = $(event.target).prop('id').split("-")[2];
            var displays = $("span." + className);
            var displayValue = "";
            if (locNumber > 0 && event.target.value == "") {
              displayValue = "Location " + locNumber;
            } else {
              displayValue = event.target.value;
            }
            $(displays).each(function(i, element) {
              $(element).text(displayValue);
            });
          });

          $document.on("blur", ".loc-address", function (event) {
            var parts = this.id.split("-");
            var locationNumber = parts[parts.length - 1];
            var fullAddress = getFullAddress(locationNumber);
            $('.full-address-' + locationNumber).text(fullAddress);
          });

          //Radio event listener
          $document.on("click", "input[type=radio]", function (event) {
            console.log("hi");
            var target = event.target;
            var parts = target.name.split("-");
            var locationNumber = parts[parts.length - 1];
            //Check which radio button it is and which content it's show/hiding
            if (target.name == "affiliated") {
              if (target.id == 'affiliated-yes') {
                $('#affiliated-split-input').removeClass("hidden");
                $('.affiliated-no-answer').addClass("hidden");
                updateAffiliatedSummary();
              } else if (target.id == 'affiliated-no') {
                $('#affiliated-split-input').addClass("hidden");
                $('.affiliated-no-answer').removeClass("hidden");
                $('.affiliated-yes-answer').addClass("hidden");
                $('.affiliated-yes-blank-answer').addClass("hidden");
              }

              //**********
              //Recalculate summary totals
              //**********

            } else if (target.name == "lock-down-" + locationNumber) {
              if (target.id == 'lock-down-yes-' + locationNumber) {
                $('#lock-down-period-'+locationNumber).removeClass("hidden");
                topUpRateCalculation(locationNumber, 1);
              } else if (target.id == 'lock-down-no-' + locationNumber) {
                $('#lock-down-period-'+locationNumber).addClass("hidden");
                $('#lock-down-ineligible-'+locationNumber).removeClass("hidden");
                $('#lock-down-eligible-'+locationNumber).addClass("hidden");
                topUpRateCalculation(locationNumber);
              }
            } else if (target.name = "owner-location-" + locationNumber) {
              if (target.id == 'owner-location-yes-' + locationNumber) {
                $('.own-location-'+locationNumber).removeClass("hidden");
                $('.rent-location-'+locationNumber).addClass("hidden");
                $('#choose-own-or-rent-message-'+locationNumber).addClass("hidden");
              } else if (target.id == 'owner-location-no-' + locationNumber) {
                $('.own-location-'+locationNumber).addClass("hidden");
                $('.rent-location-'+locationNumber).removeClass("hidden");
                $('#choose-own-or-rent-message-'+locationNumber).addClass("hidden");
              }
              expenseFieldHideShow(locationNumber);
            }
            recalculateLocationAmounts(locationNumber);
          });

          //Calculation method event listener
          $document.on("change", "select", function (event) {
            var target = event.target;
            var parts = target.id.split("-");
            var locationNumber = parts[parts.length - 1];
            if (target.id == 'calc-method-' + locationNumber) {
              expenseFieldHideShow(locationNumber);
            } else if ($(target).parents('.own-location-' + locationNumber).length) {
              //change dates
              var expenseType = target.id.split("-")[2];
              updateDateRangeInputs(locationNumber, expenseType);
              recalculateLocationAmounts(locationNumber);
            }
          });

          /**
           * updateDateRageInputs
           *
           * Updates the date ranges for owned locations based on the location number
           */
          function updateDateRangeInputs(locationNumber, expenseType) {
            var calcMethod = $('#date-chooser-' + expenseType + '-' + locationNumber + ' option:selected').data("calc-method");
            var rangeISO = $('#claim-period').find('option:selected').val()
            if (calcMethod == "none" || rangeISO == "") {
              $('#'+ expenseType +'-date-error-' + locationNumber).removeClass("hidden");
              $('#'+ expenseType +'-date-' + locationNumber).addClass("hidden");
              return;
            }
            var startDateISO = rangeISO.substring(0, rangeISO.indexOf(sep.iso[wb.lang])),
                endDateISO = rangeISO.substring(rangeISO.indexOf(sep.iso[wb.lang]) + sep.iso[wb.lang].length, rangeISO.length);
            if (calcMethod == "period") {
              //get the start/end based on the period start/end dates
              var startDate = startDateISO;
              var endDate = endDateISO;
            } else if (calcMethod == "month") {
              var startDateParts = startDateISO.split("-");
              var endDateParts = endDateISO.split("-");
              var startDate = startDateISO;
              var endDate = endDateISO;
            } else if (calcMethod == "year") {
              var startDate = "2020-01-01";
              var endDate = "2020-12-31";
            }
            $('.date-' + expenseType + '-start-' + locationNumber).text(startDate);
            $('.date-' + expenseType + '-end-' + locationNumber).text(endDate);
            $('#'+ expenseType +'-date-error-' + locationNumber).addClass("hidden");
            $('#'+ expenseType +'-date-' + locationNumber).removeClass("hidden");
          }

          function expenseFieldHideShow(locationNumber) {
            var calcMethod = $("#calc-method-" + locationNumber + " option:selected").data("calc-method");
            //unhide calc method form based on the dropdown selection
            if ($('#choose-own-or-rent-message-' + locationNumber).is(":hidden")) { //ensure an own or rent option is selected first
              if (calcMethod == "month") {
                $('.month-one-' + locationNumber).removeClass("hidden");
                $('.month-two-' + locationNumber).removeClass("hidden");
                $('.cers-period-' + locationNumber).addClass("hidden");
              } else if (calcMethod == "period") {
                $('.month-one-' + locationNumber).addClass("hidden");
                $('.month-two-' + locationNumber).addClass("hidden");
                $('.cers-period-' + locationNumber).removeClass("hidden");
              }
            }
            recalculateLocationAmounts(locationNumber);
          }

          $("#affiliated-split").on('blur', updateAffiliatedSummary);
          /**
          * updateAffiliatedSummary
          *
          * Updates the summary for affiliated section when there is an input field for the split visible
          */
          function updateAffiliatedSummary() {
            //unhide calc method form based on the dropdown selection
            if (!$('#affiliated-split').val()) { //if the input is blank
              $('.affiliated-yes-answer').addClass("hidden");
              $('.affiliated-yes-blank-answer').removeClass("hidden");
            } else {
              //update the amount in the summary
              var affiliatedPerc = parseFloat($('#affiliated-split').val());
              var maxAffiliatedAmt = (affiliatedPerc * 300000) / 100;
              affiliatedPerc = affiliatedPerc;
              var affiliatedRemainder = 100 - affiliatedPerc;
              if (affiliatedPerc <= 100 && affiliatedPerc >= 0) {
                $('.affiliated-entity-percentage').text(affiliatedPerc + '%');
                $('#affiliated-max-amount').text(toMoney.format(maxAffiliatedAmt));
                $('#affiliated-remaining').text(affiliatedRemainder + '%');
                $('.affiliated-yes-answer').removeClass("hidden");
                $('.affiliated-yes-blank-answer').addClass("hidden");
              }
            }
            calculateTotals();
          }

          $document.on("blur", ".lock-down-dates", function (event) {
            var parts = this.id.split("-");
            var locationNumber = parts[parts.length - 1];
            topUpRateCalculation(locationNumber);
            recalculateLocationAmounts(locationNumber);
          });

          var topUpRate = 0;
          function topUpRateCalculation(locationNumber, radioFlag) {
            if (radioFlag === undefined) {
              radioFlag = 0;
            }
            var datediff = getDateDiffLockdown(locationNumber);
            if (datediff >= 7 && ($('#lockdown-start-'+locationNumber).is(":visible") || radioFlag == 1)) { //at least 7 days in the
              $('#top-up-days-'+locationNumber).text(datediff);
              var updatedByElements = $('*[data-updated-by="top-up-days-' + locationNumber + '"]'); //also update the relevant summary table lines
              $(updatedByElements).each(function (i, element) {
                $(element).text(datediff);
              });
              if (cersRate > 0) { //no rent subsidy rate, no top rate
                topUpRate = getLocationTopUpRate(datediff, locationNumber).toFixed(2);
                $('.top-up-rate-'+locationNumber).text(topUpRate + "%");
                $('#lock-down-ineligible-'+locationNumber).addClass("hidden");
                $('#lock-down-eligible-'+locationNumber).removeClass("hidden");
              } else {
                $('#lock-down-ineligible-'+locationNumber).removeClass("hidden");
                $('#lock-down-eligible-'+locationNumber).addClass("hidden");
                $('.top-up-rate-'+locationNumber).text("0" + "%");
              }
            } else {
              //repeat of above...
              $('#top-up-days-'+locationNumber).text(0);
              $('#lock-down-ineligible-'+locationNumber).removeClass("hidden");
              $('#lock-down-eligible-'+locationNumber).addClass("hidden");
              $('.top-up-rate-'+locationNumber).text("0" + "%");
            }
            recalculateLocationAmounts(locationNumber);
            calculateTotals();
          }

          //Gets the number of days between the start and end date of the lockdown period for a location
          function getDateDiffLockdown(locationNumber) {
            var startDate = $("#lockdown-start-" + locationNumber).val();
            var endDate = $("#lockdown-end-" + locationNumber).val();
            var date1Arr = startDate.split("-");
            var date2Arr = endDate.split("-");
            var date1 = new Date(Date.UTC(date1Arr[0], date1Arr[1]-1, date1Arr[2]));
            var date2 = new Date(Date.UTC(date2Arr[0], date2Arr[1]-1, date2Arr[2]));
            return Math.round((date2 - date1) / (1000*60*60*24)) + 1;
          }
          //Gets the top up rate for the location, unrounded
          function getLocationTopUpRate(dateDiff, locationNumber) {
            return (dateDiff * 25) / 28;
          }


          //when the user clicks the remove button on an location panel
          $(document).on("click", ".rm-loc", function(event) {
            var fieldset = $(event.target).parent("fieldset");
            var id = $(fieldset).attr("id");
            var locNumber = id.split("-")[1];
            $("#loc" + locNumber).remove();
            $(fieldset).remove();
          });

          //https://stackoverflow.com/questions/3885817/how-do-i-check-that-a-number-is-float-or-integer
          function isInt(n) {
            return Number(n) === n && n % 1 === 0;
          }
          function isFloat(n) {
            return Number(n) === n && n % 1 !== 0;
          }

          /**
           * calculate the totals when the summary table is opened
           */
          $(document).on("click", "#showLocTable", function (event) {
            calculateTotals();
          });

          function calculateTotals() {
            var smryTotals = [0, 0, 0, 0, 0, 0, 0];
            var qreLocations = [];
            var qreAmounts =  [];
            var eligibleLocations = 0;
            var qreForLocation = 0;
            //for each element in table
            $("#dataset-filter > tbody > tr").each(function (i, element) {
              var locNum = $(element).prop("id").split("loc")[1];
              eligibleLocations++;
              smryTotals[0] += zeroIfEmpty($("#rent-smry-" + locNum).text().replace("$","").split(",").join(""));
              smryTotals[1] += zeroIfEmpty($("#tax-smry-" + locNum).text().replace("$","").split(",").join(""));
              smryTotals[2] += zeroIfEmpty($("#insurance-smry-" + locNum).text().replace("$","").split(",").join(""));
              smryTotals[3] += zeroIfEmpty($("#interest-smry-" + locNum).text().replace("$","").split(",").join(""));
              smryTotals[4] += zeroIfEmpty($("#lease-smry-" + locNum).text().replace("$","").split(",").join(""));
              qreForLocation = zeroIfEmpty($("#qre-smry-" + locNum).text().replace("$","").split(",").join(""))
              smryTotals[5] += qreForLocation;
              if (qreForLocation > 0) {
                qreLocations.push(locNum);
                qreAmounts.push(qreForLocation);
              }
              smryTotals[6] += zeroIfEmpty($("#top-up-smry-" + locNum).text().replace("$","").split(",").join(""));
            });
            $(".numLocs").text(eligibleLocations);
            $(".rent-total").html(toMoney.format(smryTotals[0]));
            $(".tax-total").html(toMoney.format(smryTotals[1]));
            $(".insurance-total").html(toMoney.format(smryTotals[2]));
            $(".interest-total").html(toMoney.format(smryTotals[3]));
            $(".lease-total").html(toMoney.format(smryTotals[4]));
            $(".qre-total").html(toMoney.format(smryTotals[5]));
            $(".top-up-total").html(toMoney.format(smryTotals[6]))

            //calculate step 5 totals
            if ($(".affiliated-no-answer").is(":visible")) {
              var affiliatedSplit = 100;
            } else {
              var affiliatedSplit = zeroIfEmpty($('#affiliated-split').val().replace("%",""));
            }
            var line170Total = Math.min(300000 * affiliatedSplit / 100, smryTotals[5]);
            line170Total = line170Total.toFixed(2);
            $('.qualifying-rent-expenses').html(toMoney.format(line170Total));
            var baseAmount = (line170Total * cersRate) / 100;
            var claimTotal = baseAmount + smryTotals[6];
            baseAmount = baseAmount.toFixed(2);
            claimTotal = claimTotal.toFixed(2);
            $('.base-subsidy-amount').html(toMoney.format(baseAmount));
            $('.rent-subsidy-claim-total').html(toMoney.format(claimTotal));
            //Get the 3 locations with the highest qualifying expenses to add to the summary for the application form
            var firstQre = 0;
            var firstLocation = 0;
            var secondQre = 0;
            var secondLocation = 0;
            var thirdQre = 0;
            var thirdLocation = 0;

            for (var i = 0; i < qreAmounts.length; i++) {
              if (qreAmounts[i] > firstQre) {
                thirdQre = secondQre;
                secondQre = firstQre;
                firstQre = qreAmounts[i];
                thirdLocation = secondLocation;
                secondLocation = firstLocation;
                firstLocation = qreLocations[i];
              } else if (qreAmounts[i] > secondQre) {
                thirdQre = secondQre;
                secondQre = qreAmounts[i];
                thirdLocation = secondLocation;
                secondLocation = qreLocations[i];
              } else if (qreAmounts[i] > thirdQre) {
                thirdQre = qreAmounts[i];
                thirdLocation = qreLocations[i];
              }
            }
            //the first._location == locNum of the top location for the application form
            var locationName = "";
            if (firstQre > 0) { //if there's only 1 location, then don't bother showing this in the summary
              //add location 1 to the summary
              locationName = getFullAddress(firstLocation);
              if (locationName == "") {
                locationName = "Location " + firstLocation;
              }
              $('#smry-staddress-1').text(locationName);
              $('#smry-staddress-1').removeClass("hidden");
              $('#smry-staddress-desc').removeClass("hidden");
            } else {
              $('#smry-staddress-1').addClass("hidden");
              $('#smry-staddress-desc').addClass("hidden");
            }
            if (secondQre > 0) { //if there's only 1 location, then don't bother showing this in the summary
              //add location 2 to the summary
              locationName = getFullAddress(secondLocation);
              if (locationName == "") {
                locationName = "Location " + secondLocation;
              }
              $('#smry-staddress-2').text(locationName);
              $('#smry-staddress-2').removeClass("hidden");
            } else {
              $('#smry-staddress-2').addClass("hidden");
            }
            if (thirdQre > 0) {
              //add location 3 to the summary
              locationName = getFullAddress(thirdLocation);
              if (locationName == "") {
                locationName = "Location " + thirdLocation;
              }
              $('#smry-staddress-3').text(locationName);
              $('#smry-staddress-3').removeClass("hidden");
            } else {
              $('#smry-staddress-3').addClass("hidden");
            }
          }

          /*
          * getFullAddress
          *
          * Returns the concatenated address fields, with commas, as a string
          *
          * @param {locationNumber} integer defining the location panel to reference
          */
          function getFullAddress(locationNumber) {
            var fullAddress = "";
            var address = [
              $('#loc-staddress-' + locationNumber).val(),
              $('#loc-city-' + locationNumber).val(),
              $('#loc-prov-' + locationNumber).val(),
              $('#loc-postcode-' + locationNumber).val()
            ];
            for (let i = 0; i < address.length; ++i) {
              if (address[i] != "" && address[i] != "--" && address[i] != null) {
                fullAddress = fullAddress + address[i] + ", ";
              }
            }
            fullAddress = fullAddress.substring(0, fullAddress.length - 2);
            return fullAddress;
          }

          /**
           * add a new location form
           */
          var numLocationPanels = 1;
          $("#addLoc").on("click", addLoc);
          $("#addLoc").on("keypress", addLoc);
          function addLoc() {
            numLocationPanels++;
            var frag = locationFormGenerator.generateNewLocationForm(
              numLocationPanels
            );
            //create new row for the calculation table
            var row = document.createElement("tr");
            row.id = "loc" + numLocationPanels;

            //create new row in the summary table
            //location 'name' cell
            var eligibleLocationCell = document.createElement("td");
            var locSpan = document.createElement("span");
            $(locSpan).addClass("full-address-" + numLocationPanels);
            locSpan.innerHTML = "Location " + numLocationPanels;
            eligibleLocationCell.appendChild(locSpan);
            //create the cells
            var expenseCells = [];
            for (var i = 0; i < 8; i++) {
              expenseCells[i] = document.createElement("td");
            }
            //add the data-update-by attr so these cells are populated by the blur event on *[data-updates]
            $(expenseCells[0]).attr("id", "top-up-days-smry-" + numLocationPanels);
            $(expenseCells[0]).attr("data-updated-by", "top-up-days-" + numLocationPanels);
            $(expenseCells[0]).text("0");
            $(expenseCells[1]).attr("id", "rent-smry-" + numLocationPanels);
            $(expenseCells[1]).attr("data-updated-by", "rent-amt-" + numLocationPanels);
            $(expenseCells[2]).attr("id", "tax-smry-" + numLocationPanels);
            $(expenseCells[2]).attr("data-updated-by", "tax-amt-" + numLocationPanels);
            $(expenseCells[3]).attr("id", "insurance-smry-" + numLocationPanels);
            $(expenseCells[3]).attr("data-updated-by", "insurance-amt-" + numLocationPanels);
            $(expenseCells[4]).attr("id", "interest-smry-" + numLocationPanels);
            $(expenseCells[4]).attr("data-updated-by", "interest-amt-" + numLocationPanels);
            $(expenseCells[5]).attr("id", "lease-smry-" + numLocationPanels);
            $(expenseCells[5]).attr("data-updated-by", "lease-amt-" + numLocationPanels);
            $(expenseCells[6]).attr("id", "qre-smry-" + numLocationPanels);
            $(expenseCells[6]).attr("data-updated-by", "amt-ttl-" + numLocationPanels);
            $(expenseCells[7]).attr("id", "top-up-smry-" + numLocationPanels);
            $(expenseCells[7]).attr("data-updated-by", "amt-top-up-" + numLocationPanels);
            //put the row together
            row.appendChild(eligibleLocationCell);
            $(expenseCells).each(function (i, element) {
              row.appendChild(expenseCells[i]);
            });
            //add the row to the table
            $("#dataset-filter > tbody").append(row);
            var lastLocPanel = $("fieldset[id^='loc-']").last();
            $(frag).insertAfter(lastLocPanel);
            $("#loc-" + numLocationPanels).focus();
            document.getElementById($(frag).prop("id")).scrollIntoView({
              behavior: 'smooth'
            });

            //reinitialize the datepickers and expand hide after adding it to page
            $("#loc-"+numLocationPanels).find( wb.allSelectors )
              .addClass( "wb-init" )
              .filter( ":not(#" + "loc-"+numLocationPanels + " .wb-init .wb-init)" ).trigger( "timerpoke.wb" );

            //now after resettting the default values of the datepickers based on the claim period selection
            var rangeISO = $('#claim-period').find('option:selected').val(),
              startDateISO = rangeISO.substring(0, rangeISO.indexOf("--")),
              endDateISO = rangeISO.substring(rangeISO.indexOf("--") + 2, rangeISO.length),
              rangeClaim = $('#claim-period').find("option:selected").text(),
              rangeClaimNo = rangeClaim.substring(7, 8),
              startDateClaim = rangeClaim.substring(0, rangeClaim.indexOf("--")),
              endDateClaim = rangeClaim.substring(rangeClaim.indexOf("--") + 2, rangeClaim.length);
              $('#lockdown-start-'+numLocationPanels).attr({
              "min": startDateISO,
              "max": endDateISO,
              "value": startDateISO
            });
            $('#lockdown-start-'+numLocationPanels).val(startDateISO);
            $('#lockdown-end-'+numLocationPanels).attr({
              "min": startDateISO,
              "max": endDateISO,
              "value": endDateISO
            });
            $('#lockdown-end-'+numLocationPanels).val(endDateISO);

          }

          /**
           * calculate the CERS rate reductions
           */
          var currentRevReduc = 0;
          var priorRevReduc = 0;
          var revReduction = 0;
          var cersRate = 0;
          $document.on("change", "#rate-reduction", function (event) {
            var rangeISO = $('#claim-period').find('option:selected').val();
            var claimMonth = getClaimMonth(rangeISO);
            if ($("#2020-" + claimMonth + "-no").is(":visible")) {
              calculateRevenueDrop(false);
            } else if ($("#2020-" + claimMonth + "-yes").is(":visible")) {
              calculateRevenueDrop(true);
            } else { //shouldn't actually happen... but display 0 if it does as failsafe
              NoCERSRate();
            }
          });
          $document.on("blur", ".cers-rate-calc", function(event) {
            calculateRevenueDrop(false)
          });
          $document.on("blur", ".cers-rate-calc-alt", function(event) {
            calculateRevenueDrop(true)
          });
          function calculateRevenueDrop(bAlt) {
            var claimPeriod = parseInt($("#claim-period option:selected").data("claim-period"));
            var CERSRateElements = $('.cers-rate-calc');
            //find the claim month based on the chosen claim period
            var claimMonth = getClaimMonth($("#claim-period").val());
            //Get claim months function??
            var monthsArray = getClaimMonths(claimMonth, claimPeriod);
            var months2019Array = getClaimMonths2019(claimMonth);
            if (bAlt) { //alternate baseline method
              var janRev = zeroIfEmpty($("#2020-01-yes").val());
              var febRev = zeroIfEmpty($("#2020-02-yes").val());
              if (parseFloat(janRev) > 0 || parseFloat(febRev) > 0) {
                var baseRev = (janRev + febRev) / 2;
                //get the value of the claim month
                var claimMonthValue = zeroIfEmpty($("#" + monthsArray[0] + "-yes").val());
                //get the value of the previous month
                var prevClaimValue = zeroIfEmpty($("#" + monthsArray[1] + "-yes").val());
                //get the revenue reduction from claim/prev claim months from 2020 and 2019
                currentRevReduc = (baseRev - claimMonthValue) / baseRev;
                priorRevReduc = (baseRev - prevClaimValue) / baseRev;
                //get the higher rev reduction
                revReduction = Math.max(currentRevReduc, priorRevReduc);
              } else {
                NoCERSRate();
                return;
              }
            } else { //comparing with 2019 revenue
              if (
                  zeroIfEmpty($("#" + months2019Array[0] + "-no").val()) > 0 ||
                  zeroIfEmpty($("#" + months2019Array[1] + "-no").val()) > 0
              ) {
                //get the value of the claim month
                var claimMonth2020Value = zeroIfEmpty($("#" + monthsArray[0] + "-no").val());
                var claimMonth2019Value = zeroIfEmpty($("#" + months2019Array[0] + "-no").val());
                //get the value of the previous month
                var prevClaim2020Value = zeroIfEmpty($("#" + monthsArray[1] + "-no").val());
                var prevClaim2019Value = zeroIfEmpty($("#" + months2019Array[1] + "-no").val());
                //get the revenue reduction from claim/prev claim months from 2020 and 2019
                if (claimMonth2019Value == 0) {
                  currentRevReduc = 0;
                } else {
                  currentRevReduc = (claimMonth2019Value - claimMonth2020Value) / claimMonth2019Value;
                }
                if (prevClaim2019Value == 0) {
                  priorRevReduc = 0;
                } else {
                  priorRevReduc = (prevClaim2019Value - prevClaim2020Value) / prevClaim2019Value;
                }
                //get the higher rev reduction
                revReduction = Math.max(currentRevReduc, priorRevReduc);
              } else {
                NoCERSRate();
                return;
              }
            }
            if (revReduction > 0) {
              //get the base rate
              cersRate = parseFloat(Math.max(getRentSubsidyRate(revReduction), 0));
              //round to nearest
              cersRate = cersRate * 100;
              cersRate = cersRate.toFixed(2);
              $(".currentRevReduction").text(roundPercDown(currentRevReduc) + "%");
              $(".priorRevReduction").text(roundPercDown(priorRevReduc) + "%");
              $(".preferentialRevReduction").text(roundPercDown(revReduction) + "%");
              $(".base-rate").text(cersRate + "%");
            } else {
              NoCERSRate();
              return;
            }
            recalculateAllLocations();
          }


          /**
          * NoCERSRate()
          * Fill in default values of 0% when there's not enough information to determine the rate
          */
          function NoCERSRate() {
            $(".currentRevReduction").text("0%");
            $(".priorRevReduction").text("0%");
            $(".preferentialRevReduction").text("0%");
            $(".base-rate").text("0%");
            $("#rate-formula-max").addClass("hidden");
            $("#rate-formula-u70").addClass("hidden");
            $("#rate-formula-u50").addClass("hidden");
            $("#rate-formula-0").removeClass("hidden");
            recalculateAllLocations();
          }

          function recalculateAllLocations() {
            $(".lock-down-dates").each(function (i, element) {
              var parts = $(element).prop("id").split("-");
              var locationNumber = parts[parts.length - 1];
              topUpRateCalculation(locationNumber);
              recalculateLocationAmounts(locationNumber);
            });
            calculateTotals();
          }

          /**
           * getClaimMonths()
           * returns an array of the 4 months with year and prefix based on the claim month
           */
          function getClaimMonths(claimMonth, claimPeriod) {
            var monthsArray = [claimMonth, claimMonth - 1, claimMonth - 2, claimMonth - 3];

            //Adding a 0 in front of a month in case it was single digit
            for (var i = 0; i < monthsArray.length; i++) {
              if (monthsArray[i].toString().match(/^[1-9]$/)) { //checking for single digit, in which case add 0 ahead of it
                monthsArray[i] = "0" + monthsArray[i];
              }
              //get the year for the month based on period
              if (claimPeriod < 11) {
                monthsArray[i] = "2020-" + monthsArray[i];
              } else if (claimPeriod < 15) {
                if (parseInt(monthsArray[i]) > 5) {
                  monthsArray[i] = "2020-" + monthsArray[i];
                } else {
                  monthsArray[i] = "2021-" + monthsArray[i];
                }
              } else {
                monthsArray[i] = "2021-" + monthsArray[i];
              }
            }
            return monthsArray;
          }
           /**
           * getClaimMonths2019()
           * returns an array of the 4 months adjusted for year 2019
           */
           function getClaimMonths2019(claimMonth) {
            var monthsArray = [claimMonth, claimMonth - 1, claimMonth - 2, claimMonth - 3];

            //Adding a 0 in front of a month in case it was single digit
            for (var i = 0; i < monthsArray.length; i++) {
              if (monthsArray[i].toString().match(/^[1-9]$/)) { //checking for single digit, in which case add 0 ahead of it
                monthsArray[i] = "0" + monthsArray[i];
              }
              monthsArray[i] = "2019-" + monthsArray[i];
            }
            return monthsArray;
          }
          /**
           * roundPercDown()
           * round the given percent value to two decimal places
           */
          function roundPercDown(perc) {
            perc = perc * 10000;
            perc = Math.floor(perc);
            perc = perc / 100;
            return perc;
          }

          /**
           * zeroIfEmpty()
           * return 0 if the number cannot be parsed into a float; does not account * for letter values.
           */
          function zeroIfEmpty(fieldVal) {
            if (fieldVal != null && fieldVal != "") {
              return parseFloat(fieldVal);
            } else {
              return 0;
            }
          }

          /**
           * getMonthNamesPlusYear()
           *
           * get the name of the claim month and previous month
           *
           * @param {iMonth} integer the month expressed as an integer
           * YYYY-MM-DD--YYYY--MM-DD format
           *
           * @return {claimMonths} the 2 months that the CERS period overlaps
           */
           function getMonthNamesPlusYear(iMonth, claimPeriod) {
            var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            var claimMonths = [monthNames[iMonth - 2], monthNames[iMonth - 1]];
            if (iMonth == 1) {
              claimMonths[0] = "December";
            }
            //add years
            if (claimPeriod < 4) {
              claimMonths[0] = claimMonths[0] + ' 2020';
              claimMonths[1] = claimMonths[1] + ' 2020';
            } else if (claimPeriod == 4) {
              claimMonths[0] = claimMonths[0] + ' 2020';
              claimMonths[1] = claimMonths[1] + ' 2021';
            } else {
              claimMonths[0] = claimMonths[0] + ' 2021';
              claimMonths[1] = claimMonths[1] + ' 2021';
            }
            return claimMonths;
          }

          /**
           * getClaimMonth()
           *
           * get the month where the claim period mostly falls
           *
           * @param {Int} dateRange the claim period dates in
           * YYYY-MM-DD--YYYY--MM-DD format
           *
           * @return {Int} the claim month in numeric form
           */
           var date1Max = 0;
           var date2Max = 0;
           function getClaimMonth(dateRange, type) {
            if (type === undefined) {
              type = 0;
            }
            var dates = dateRange.split('--');
            var date1Arr = dates[0].split("-");
            var date2Arr = dates[1].split("-");
            date1Arr[1] = date1Arr[1] - 1;
            date2Arr[1] = date2Arr[1] - 1;
            var date1 = new Date(Date.UTC(date1Arr[0], date1Arr[1], date1Arr[2]));
            var date2 = new Date(Date.UTC(date2Arr[0], date2Arr[1], date2Arr[2]));
            var date1Counter = 0;
            var date1Month = date1.getUTCMonth();
            var date2Counter = 0;
            var date2Month = date2.getUTCMonth();
            if (date1Month == date2Month) {
              return date1Month;
            }
            while (date1Month == date1.getUTCMonth()) {
              date1Counter++;
              date1.setUTCDate(date1.getUTCDate() + 1);
            }
            while (date2Month == date2.getUTCMonth()) {
              date2Counter++;
              date2.setUTCDate(date2.getUTCDate() - 1);
            }
            if (type == 1) { //return the overlapping days as array instead
              var overlappingMonthDays = [date1Counter, date2Counter];
              return overlappingMonthDays;
            }
            if (type == 2) {
              var maxDays = [new Date(date1Arr[0], date1Arr[1] + 1, 0).getDate(), new Date(date2Arr[0], date2Arr[1] + 1, 0).getDate()];
              return maxDays;
            }
            if (parseInt(date1Counter) < parseInt(date2Counter)) {
              return date2Month + 1;
            } else if (parseInt(date1Counter) > parseInt(date2Counter)) {
              return date1Month + 1;
            } else {
              return null;
            }
          }

          /**
           * Calculate the Rent Subsidy rate
           * @param {Float} revReduction the revenue reduction percentage represented as a decimal
           *
           * @return {Float} the calculated base rate
           */
          function getRentSubsidyRate(revReduction) {
            $("#rate-formula-max").addClass("hidden");
            $("#rate-formula-u70").addClass("hidden");
            $("#rate-formula-u50").addClass("hidden");
            $("#rate-formula-0").addClass("hidden");
            if (revReduction > 0.7) {
              $("#rate-formula-max").removeClass("hidden");
              return 0.65;
            } else if (revReduction > 0.5) {
              $("#rate-formula-u70").removeClass("hidden");
              return 1.25 * (revReduction - 0.5) + 0.4;
            } else if (revReduction <= 0) {
              $("#rate-formula-0").removeClass("hidden");
              return 0;
            } else {
              $("#rate-formula-u50").removeClass("hidden");
              return revReduction * 0.8;
            }
          }


          // Bind the init event of the plugin
          $document.on("timerpoke.wb " + initEvent, selector, init);
          // Add the timer poke to initialize the plugin
          wb.add(selector);
        })(jQuery, window, wb);
        $(document).on("wb-ready.wb", function () {
          $("#reduction-percent-panel").addClass("hidden");
        });

        $(document).on("click", ".toCSV", function (event) {
          export_table_to_csv("location-cews.csv");
        });

        /**
         * export_table_to_csv
         *
         * https://jsfiddle.net/gengns/j1jm2tjx/
         */
        function export_table_to_csv(filename) {
          var csv = [];
          var rows = $("#dataset-filter tr");
          for (var i = 0; i < rows.length; i++) {
            var row = [], cols = rows[i].querySelectorAll("td, th");

            for (var j = 0; j < cols.length; j++) {
              if (document.documentElement.lang == "fr") {
                var val = cols[j].innerText.replace(",", ".");
                val = val.replace(/,/g, ".")
                val = val.replace(/\s/g, "")
                row.push(val);
              } else {
                row.push(cols[j].innerText.replace(",", ""));
              }
            }

            csv.push(row.join(","));
          }
          // Download CSV
          download_csv(csv.join("\n"), filename);
        }
        /**
         * download_csv
         *
         * https://jsfiddle.net/gengns/j1jm2tjx/
         *
         */
        function download_csv(csv, filename) {
          var csvFile;
          var downloadLink;

          // CSV FILE
          csv = "\uFEFF" + csv;
          csvFile = new Blob([csv], { type: "text/csv", encoding: "UTF-8" });

          // Download link
          downloadLink = document.createElement("a");

          // File name
          downloadLink.download = filename;

          // We have to create a link to the file
          downloadLink.href = window.URL.createObjectURL(csvFile);

          // Make sure that the link is not displayed
          downloadLink.style.display = "none";

          // Add the link to your DOM
          document.body.appendChild(downloadLink);

          // Lanzamos
          downloadLink.click();
        }

        /**
         * required to allow duplicated popup buttons to open the associated popup
         */
        function showPopup(id) {
          (function ($, wb) {
            'use strict';
            var $document = wb.doc;
            $document.trigger("open.wb-lbx", [
              [
                {
                  src: "#" + id,
                  type: "inline"
                }
              ],
              false
            ]);
          })(jQuery, wb);
        }
      </script>
      <script>

        $(".action-checkbox").change(function () {
          if ($('.action-checkbox:checked').length == $('.action-checkbox').length) {
            $("#action-msg1").removeClass("hidden").addClass("visible");
            $("#action-no-msg").addClass("hidden").removeClass("visible");
          }
          if ($('.action-checkbox:checked').length !== $('.action-checkbox').length) {
            $("#action-msg1").addClass("hidden").removeClass("visible");
            $("#action-no-msg").removeClass("hidden").addClass("visible");
          }
        })

      </script>
   </body>
</html>
